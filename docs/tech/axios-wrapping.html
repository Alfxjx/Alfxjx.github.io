<!DOCTYPE html><html lang="en"><head><link rel="stylesheet" href="/style/index.css"/><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&amp;display=swap"/><script async="" defer="" data-website-id="3890bdd6-8ff5-4da5-8b72-45ba24876897" src="https://umami-alfxjx.up.railway.app/umami.js"></script><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/2649b9740f492fab27ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2649b9740f492fab27ec.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8fa755d3830e88407993.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8fa755d3830e88407993.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-6c6eb080c4d41d8fd79b.js" defer=""></script><script src="/_next/static/chunks/main-4fc50673e5500481d568.js" defer=""></script><script src="/_next/static/chunks/pages/_app-075949e5fa5ffddc911e.js" defer=""></script><script src="/_next/static/chunks/252f366e-b63e9f131b12ce609c69.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-b8804bb07d4f86914404.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-eb29eaaad2b07bc95110.js" defer=""></script><script src="/_next/static/chunks/1a48c3c1-63272919e4bbaae4097e.js" defer=""></script><script src="/_next/static/chunks/608-bb5bf9a1b1d10ad22ac0.js" defer=""></script><script src="/_next/static/chunks/553-f50d93340fc41d40714e.js" defer=""></script><script src="/_next/static/chunks/307-d4f637d0181fb2085729.js" defer=""></script><script src="/_next/static/chunks/pages/tech/%5Bslug%5D-6a6947d46afa43b14f3e.js" defer=""></script><script src="/_next/static/Q5-ARss9H4OnstBP8NDja/_buildManifest.js" defer=""></script><script src="/_next/static/Q5-ARss9H4OnstBP8NDja/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap">@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrFJM.woff) format('woff')}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9V1g.woff) format('woff')}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJbecnFHGPezSQ.woff2) format('woff2');unicode-range:U+0900-097F,U+1CD0-1CF6,U+1CF8-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FB}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJnecnFHGPezSQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJfecnFHGPc.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z11lFd2JQEl8qw.woff2) format('woff2');unicode-range:U+0900-097F,U+1CD0-1CF6,U+1CF8-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FB}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1JlFd2JQEl8qw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFd2JQEk.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="Post__Wrapper-sc-q8sq7-0 dzXARM"><div class="ProgressBar__FixedTopWrapper-sc-1ufpd9c-0 ProgressBar__ProgressBarWrapperFixed-sc-1ufpd9c-1 lmAxqe ketkUq"><div class="bar-used"></div></div><div class="header"><div class="icon-wrapper"><div class="icons"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 11H6.414l5.293-5.293-1.414-1.414L2.586 12l7.707 7.707 1.414-1.414L6.414 13H21z"></path></svg></div><div class="icons"><a href="/tech"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m7.375 16.781 1.25-1.562L4.601 12l4.024-3.219-1.25-1.562-5 4a1 1 0 0 0 0 1.562l5 4zm9.25-9.562-1.25 1.562L19.399 12l-4.024 3.219 1.25 1.562 5-4a1 1 0 0 0 0-1.562l-5-4zm-1.649-4.003-4 18-1.953-.434 4-18z"></path></svg></a></div></div></div><div class="toggle"><button class="switch__SwitchWrapper-sc-19ps08m-0 eMIOez"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path></svg><div class="round"></div></button></div><div style="height:3.25rem"></div><div class="Post-sc-1u8x57o-0 Post__PostWrapper-sc-q8sq7-1 hcSpXI fqyuhB"><div class="info"><h1>On Axios Requests &amp; Wrapping</h1><div class="user"><img class="img" src="/assets/authors/alfxjx.jpg" alt="Alfxjx"/><span class="title">Alfxjx</span><div class="date">2022-02-22</div></div></div><div class="post"><h2>why axios？</h2>
<p>前后端交互最常见的就是 <code>http</code> 请求，为了提高效率，需要对 <code>http</code> 请求进行封装，目前的现代开发过程中，可以使用 Axios，一种对于 <code>http</code> 请求的封装，或者是<code>fetch</code>，全新的异步请求<code>api</code>，本文主要是介绍我们项目中是如何根据后端返回的类型，对请求进行封装。</p>
<p><a href="https://www.axios-http.cn/">Axios</a> 是一个基于 promise 的网络请求库，可以用于浏览器和 <code>node.js</code>。<code>api</code> 简单，返回一个 <code>Promise</code> 对象，以供异步的处理。
<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API">Fetch API</a> 提供了一个 JavaScript 接口，用于访问和操纵 <code>HTTP</code> 管道的一些具体部分，例如请求和响应。它还提供了一个全局 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/fetch">fetch()</a> 方法，该方法提供了一种简单，合理的方式来跨网络异步获取资源。
事实上两种都可以，相信你看了这篇文章之后也可以自己封装一下 <code>fetch</code>，甚至可以使用适配器模式去一统两种 api。那下面就看看是怎么对 <code>axios</code> 进行封装的。</p>
<h2>Requests</h2>
<p>首先先看看实际生产中，<code>axios</code> 需要做什么工作:</p>
<h3>拦截器，错误处理</h3>
<p><code>axios</code> 在使用的过程中需要生成一个 <code>axiosBase</code> 实例，从开始发送请求到收到响应可以分成以下几个过程：</p>
<ol>
<li>发起请求 <code>axiosInstance.get()</code></li>
<li>进入请求拦截器 <code>axiosBase.interceptors.request.use(...requestIntercepter);</code></li>
<li>(server) 服务端进行响应</li>
<li>进入响应拦截器 <code>axiosBase.interceptors.response.use(responseIntercepter);</code></li>
<li>返回响应，在业务中进行使用。</li>
</ol>
<p>可以看出除了请求和响应之外，<code>axios</code> 提供的最多的配置就是请求拦截和响应拦截，程序设计的目的就是写出可维护并且能复用的代码，因此在两个拦截器中类似管道做通用的处理。</p>
<h3>请求和响应</h3>
<ol>
<li>业务中常见的有 <code>GET/POST/PUT</code> 请求，<code>post</code> 请求又会根据 <code>content-type</code> 分成两种，针对这些变化的量，锚定住代码中不变的量，需要进行设计。</li>
<li>在常见的业务中，可能会是使用 <code>access-token</code> 的方式进行鉴权，在请求的拦截器中，可以拿到 <code>config</code> 参数，可以添加认证信息</li>
<li>对于返回的响应报文，由于一般的返回报文是一样的，在响应拦截器中对响应进行第一步的通用处理，减少业务端的重复代码。</li>
</ol>
<h3>业务异常 VS Http 异常</h3>
<p>响应拦截中，最常见的就是对异常情况进行处理，由于 <code>axios</code> 返回的是一个 <code>Promise</code>对象，因此要对返回的结果进行处理判断，之后返回 <code>Promise.reject</code> / <code>Promise.resolve</code>; 对于 <code>http</code> 的异常来说，由于本身就是一个 error，一般会放在 <code>Promise.catch</code> 里面去处理。</p>
<h2>Wrapping</h2>
<h3>生成实例</h3>
<p>一般来说 baseURL 是不太会改变的,如果项目如果是比较稳定的话，可以把全局的设置也写上，如： <code>withCredentials</code></p>
<pre><code>axios.defaults.headers.post["Content-Type"] = "application/json";
axios.defaults.withCredentials = true;
const baseURL = NODE_ENV === "development" ? "/api" : VUE_APP_PROD_API;

// 基本的axios实例
const axiosBase = axios.create({
	baseURL: baseURL,
});
</code></pre>
<p>如果项目中依赖多个 api，那么这里可以生成多个实例，配置不同的 baseURL (开发中需要配置对于的 proxies).</p>
<pre><code>// next.js 之类的 jamstack，可以自己生成 api routes 的，具有不同的 backend
const axioRoutes = axios.create({
	baseURL: "/api-routes",
});
</code></pre>
<h3>拦截器</h3>
<p>拦截器的主要功能就是对请求和响应进行处理，包装，最常见的就是附带 token 进行鉴权的操作：</p>
<pre><code>axiosBase.interceptors.request.use((config: AxiosRequestConfig) => {
	const token = sessionStorage.getItem("token");
	if (token &#x26;&#x26; config.headers) {
		config.headers.Authorization = `Bearer ${token}`;
	}
	return config;
});
axiosBase.interceptors.response.use(
	(res: AxiosResponse&#x3C;IResponse&#x3C;any>>) => {
		if (!res) {
			return false;
		}
		if (Object.prototype.hasOwnProperty.call(res.data, "token")) {
			sessionStorage.setItem("token", res.data.token as string);
		}
		return res;
	},
	(err: AxiosError&#x3C;{ errorMessage: string; success: boolean }>) => {
		// handle the error
		return Promise.reject(err);
	}
);
</code></pre>
<h2>处理异常</h2>
<p>请求一个很重复的操作就是处理异常，一般来说异常都很有规律性，可分成业务操作错误导致的业务异常和由于请求失败导致的 HTTP 异常。</p>
<h3>业务异常</h3>
<p><code>AxiosInstance</code> 会返回一个 <code>Promise</code>，对于业务异常都是在 http returnCode 为 200 的时候。以 POST 请求为例子：</p>
<p>定义一个 标准的返回体：</p>
<pre><code>export interface IResponse&#x3C;T> {
	data: T;
	errorMessage: string;
	success: boolean;
	token?: string;
}
</code></pre>
<p>当返回 success 为 false 的时候，表示出现了业务异常。 由于是 Promise.then，可以在拦截器里面进行处理，也可以在实例返回中进行处理，这个地方如果不同的请求方法处理方式不同，就放到对应请求的实例里面去处理，反之就存在拦截器就可以。一般来说不同的请求方式返回的应是一致的：</p>
<pre><code>axiosBase.interceptors.response.use(
	(res: AxiosResponse&#x3C;IResponse&#x3C;any>>) => {
		if (!res) {
			return false;
		}
		if (!res.data.success) {
			notify.warning(res.data.errorMessage);
		}
		// token...
	},
	(err: AxiosError&#x3C;{ errorMessage: string; success: boolean }>) => {
		notify.error(err.response?.data.errorMessage as string);
		if (err.response?.status === 401 &#x26;&#x26; isNoAuth(window.location.pathname)) {
			setTimeout(() => {
				window.location.href = "/person/login";
			}, 1000);
		}
		return Promise.reject(err);
	}
);
</code></pre>
<h3>http error</h3>
<p>对于 http 的异常，为了能够在封装中对其进行统一处理，需要对实例返回的 Promise 进行二次封装，还是以 POST 请求为例：</p>
<pre><code>const httpFuncs = {
	post&#x3C;T>(
		url: string,
		data: any,
		config?: AxiosRequestConfig
	): Promise&#x3C;AxiosResponse&#x3C;IResponse&#x3C;T>>> {
		return new Promise((resolve, reject) => {
			axiosInstance
				.post(url, data, config)
				.then((res: AxiosResponse&#x3C;IResponse&#x3C;T>>) => resolve(res))
				// http error
				.catch((err: AxiosError&#x3C;IErrorProps>) => {
					console.log(err.response);
				});
		});
	},
};
</code></pre>
<p>在 <code>Promise.catch</code>中，处理返回的 http error， 主要是 401 和其他的 500 错误，这样就无需在具体的业务中关心这些异常的处理了。</p>
<h2>More</h2>
<p>到此，基本就是完成了对 <code>axios</code> 等请求库的常规封装。</p>
<h3>设计模式？</h3>
<p>或许可以使用一个 httpFactory 来对 http 请求进行统一的管理，这样就不会在从 mock 升级到正式的情况都时候，要到每一个实例里面去修改了。</p>
<pre><code>enum enumType {
	BASE,
	MOCK,
}

export class HttpFactory {
	public static getHttp(type: enumType) {
		switch (type) {
			case enumType.BASE:
				return http;
			case enumType.MOCK:
				return httpMock;
			default:
				return http;
		}
	}
}
</code></pre>
<p>使用的时候就直接使用 <code>HttpFactory.getHttp(enumType.MOCK).post&#x3C;IUserInfo>('/userinfo')</code>, 这样升级的时候，直接把枚举修改一下即可。</p>
<p>实际生产中，可以使用配置文件来写这个枚举，这样就可以做到统一的管理。</p>
<h2>End</h2>
<p><a href="">在线演示</a></p>
<p>总的来说最适合应用的才是最好的，本文只是介绍了我们在改造为 ts + axios + next.js 时候的经验，事实上对于 next.js，可以使用 <a href="https://swr.vercel.app">useSWR</a> 等库，也进行了很好的封装。</p>
<h2>References</h2>
<ol>
<li><a href="https://segmentfault.com/a/1190000021071492">比较 fetch()和 Axios</a></li>
<li><a href="https://juejin.cn/post/6968630178163458084">完整的 Axios 封装-单独 API 管理层、参数序列化、取消重复请求、Loading、状态码...</a></li>
<li><a href="https://juejin.cn/post/7053471988752318472">封装 Axios 只看这一篇文章就行了</a></li>
<li><a href="https://juejin.cn/post/6969070102868131853#heading-4">错误处理 - 最后的完善</a></li>
<li><a href="https://segmentfault.com/a/1190000021769678">vue+ts 下对 axios 的封装</a></li>
<li><a href="https://www.cnblogs.com/double-W/p/12875623.html">TS 泛型接口</a></li>
<li><a href="https://markdowner.net/article/153598623580815360">如何使用装饰器模式极大地增强 fetch()</a></li>
</ol>
</div><div id="comments"></div></div><div class="Footer__FooterWrapper-sc-1ysspqt-0 bPlNKY"><div class="my-main-font text"><span>Powerd by <a href="https://nextjs.org">Next.js</a> on<!-- --> <a href="https://vercel.com">Vercel</a> with ♥ 2020-<!-- -->2022</span></div><div class="Footer__IconList-sc-1ysspqt-1 fShAcK"><a href="https://github.com/alfxjx"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://twitter.com/alfxjx"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://weibo.com/u/1950371745"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"></path></svg></a><a href="https://juejin.cn/user/2330620383728551"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.445 21.832a1 1 0 0 0 1.11 0l9-6A.998.998 0 0 0 21.8 14.4l-9-12c-.377-.504-1.223-.504-1.6 0l-9 12a1 1 0 0 0 .245 1.432l9 6zM13 19.131V6l6.565 8.754L13 19.131zM11 6v13.131l-6.565-4.377L11 6z"></path></svg></a><a href="https://umami-alfxjx.up.railway.app/share/eaSooCGG/Blog"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M181.9 256.1c-5-16-4.9-46.9-2-46.9 8.4 0 7.6 36.9 2 46.9zm-1.7 47.2c-7.7 20.2-17.3 43.3-28.4 62.7 18.3-7 39-17.2 62.9-21.9-12.7-9.6-24.9-23.4-34.5-40.8zM86.1 428.1c0 .8 13.2-5.4 34.9-40.2-6.7 6.3-29.1 24.5-34.9 40.2zM248 160h136v328c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V24C0 10.7 10.7 0 24 0h200v136c0 13.2 10.8 24 24 24zm-8 171.8c-20-12.2-33.3-29-42.7-53.8 4.5-18.5 11.6-46.6 6.2-64.2-4.7-29.4-42.4-26.5-47.8-6.8-5 18.3-.4 44.1 8.1 77-11.6 27.6-28.7 64.6-40.8 85.8-.1 0-.1.1-.2.1-27.1 13.9-73.6 44.5-54.5 68 5.6 6.9 16 10 21.5 10 17.9 0 35.7-18 61.1-61.8 25.8-8.5 54.1-19.1 79-23.2 21.7 11.8 47.1 19.5 64 19.5 29.2 0 31.2-32 19.7-43.4-13.9-13.6-54.3-9.7-73.6-7.2zM377 105L279 7c-4.5-4.5-10.6-7-17-7h-6v128h128v-6.1c0-6.3-2.5-12.4-7-16.9zm-74.1 255.3c4.1-2.7-2.5-11.9-42.8-9 37.1 15.8 42.8 9 42.8 9z"></path></svg></a><a href="/xujianxiang-resume.pdf"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-5h2v5zm4 0h-2v-3h2v3zm0-5h-2v-2h2v2zm4 5h-2V7h2v10z"></path></svg></a></div></div></div><div class="Toast__StyledContainer-sc-1p228qg-0 gWqgDn"><div class="Toastify"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"On Axios Requests \u0026 Wrapping","date":"2022-02-22T14:22:22.712Z","slug":"axios-wrapping","author":{"name":"Alfxjx","picture":"/assets/authors/alfxjx.jpg"},"content":"\u003ch2\u003ewhy axios？\u003c/h2\u003e\n\u003cp\u003e前后端交互最常见的就是 \u003ccode\u003ehttp\u003c/code\u003e 请求，为了提高效率，需要对 \u003ccode\u003ehttp\u003c/code\u003e 请求进行封装，目前的现代开发过程中，可以使用 Axios，一种对于 \u003ccode\u003ehttp\u003c/code\u003e 请求的封装，或者是\u003ccode\u003efetch\u003c/code\u003e，全新的异步请求\u003ccode\u003eapi\u003c/code\u003e，本文主要是介绍我们项目中是如何根据后端返回的类型，对请求进行封装。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.axios-http.cn/\"\u003eAxios\u003c/a\u003e 是一个基于 promise 的网络请求库，可以用于浏览器和 \u003ccode\u003enode.js\u003c/code\u003e。\u003ccode\u003eapi\u003c/code\u003e 简单，返回一个 \u003ccode\u003ePromise\u003c/code\u003e 对象，以供异步的处理。\r\n\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API\"\u003eFetch API\u003c/a\u003e 提供了一个 JavaScript 接口，用于访问和操纵 \u003ccode\u003eHTTP\u003c/code\u003e 管道的一些具体部分，例如请求和响应。它还提供了一个全局 \u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/fetch\"\u003efetch()\u003c/a\u003e 方法，该方法提供了一种简单，合理的方式来跨网络异步获取资源。\r\n事实上两种都可以，相信你看了这篇文章之后也可以自己封装一下 \u003ccode\u003efetch\u003c/code\u003e，甚至可以使用适配器模式去一统两种 api。那下面就看看是怎么对 \u003ccode\u003eaxios\u003c/code\u003e 进行封装的。\u003c/p\u003e\n\u003ch2\u003eRequests\u003c/h2\u003e\n\u003cp\u003e首先先看看实际生产中，\u003ccode\u003eaxios\u003c/code\u003e 需要做什么工作:\u003c/p\u003e\n\u003ch3\u003e拦截器，错误处理\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eaxios\u003c/code\u003e 在使用的过程中需要生成一个 \u003ccode\u003eaxiosBase\u003c/code\u003e 实例，从开始发送请求到收到响应可以分成以下几个过程：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e发起请求 \u003ccode\u003eaxiosInstance.get()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e进入请求拦截器 \u003ccode\u003eaxiosBase.interceptors.request.use(...requestIntercepter);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e(server) 服务端进行响应\u003c/li\u003e\n\u003cli\u003e进入响应拦截器 \u003ccode\u003eaxiosBase.interceptors.response.use(responseIntercepter);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e返回响应，在业务中进行使用。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e可以看出除了请求和响应之外，\u003ccode\u003eaxios\u003c/code\u003e 提供的最多的配置就是请求拦截和响应拦截，程序设计的目的就是写出可维护并且能复用的代码，因此在两个拦截器中类似管道做通用的处理。\u003c/p\u003e\n\u003ch3\u003e请求和响应\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e业务中常见的有 \u003ccode\u003eGET/POST/PUT\u003c/code\u003e 请求，\u003ccode\u003epost\u003c/code\u003e 请求又会根据 \u003ccode\u003econtent-type\u003c/code\u003e 分成两种，针对这些变化的量，锚定住代码中不变的量，需要进行设计。\u003c/li\u003e\n\u003cli\u003e在常见的业务中，可能会是使用 \u003ccode\u003eaccess-token\u003c/code\u003e 的方式进行鉴权，在请求的拦截器中，可以拿到 \u003ccode\u003econfig\u003c/code\u003e 参数，可以添加认证信息\u003c/li\u003e\n\u003cli\u003e对于返回的响应报文，由于一般的返回报文是一样的，在响应拦截器中对响应进行第一步的通用处理，减少业务端的重复代码。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003e业务异常 VS Http 异常\u003c/h3\u003e\n\u003cp\u003e响应拦截中，最常见的就是对异常情况进行处理，由于 \u003ccode\u003eaxios\u003c/code\u003e 返回的是一个 \u003ccode\u003ePromise\u003c/code\u003e对象，因此要对返回的结果进行处理判断，之后返回 \u003ccode\u003ePromise.reject\u003c/code\u003e / \u003ccode\u003ePromise.resolve\u003c/code\u003e; 对于 \u003ccode\u003ehttp\u003c/code\u003e 的异常来说，由于本身就是一个 error，一般会放在 \u003ccode\u003ePromise.catch\u003c/code\u003e 里面去处理。\u003c/p\u003e\n\u003ch2\u003eWrapping\u003c/h2\u003e\n\u003ch3\u003e生成实例\u003c/h3\u003e\n\u003cp\u003e一般来说 baseURL 是不太会改变的,如果项目如果是比较稳定的话，可以把全局的设置也写上，如： \u003ccode\u003ewithCredentials\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eaxios.defaults.headers.post[\"Content-Type\"] = \"application/json\";\r\naxios.defaults.withCredentials = true;\r\nconst baseURL = NODE_ENV === \"development\" ? \"/api\" : VUE_APP_PROD_API;\r\n\r\n// 基本的axios实例\r\nconst axiosBase = axios.create({\r\n\tbaseURL: baseURL,\r\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e如果项目中依赖多个 api，那么这里可以生成多个实例，配置不同的 baseURL (开发中需要配置对于的 proxies).\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// next.js 之类的 jamstack，可以自己生成 api routes 的，具有不同的 backend\r\nconst axioRoutes = axios.create({\r\n\tbaseURL: \"/api-routes\",\r\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e拦截器\u003c/h3\u003e\n\u003cp\u003e拦截器的主要功能就是对请求和响应进行处理，包装，最常见的就是附带 token 进行鉴权的操作：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eaxiosBase.interceptors.request.use((config: AxiosRequestConfig) =\u003e {\r\n\tconst token = sessionStorage.getItem(\"token\");\r\n\tif (token \u0026#x26;\u0026#x26; config.headers) {\r\n\t\tconfig.headers.Authorization = `Bearer ${token}`;\r\n\t}\r\n\treturn config;\r\n});\r\naxiosBase.interceptors.response.use(\r\n\t(res: AxiosResponse\u0026#x3C;IResponse\u0026#x3C;any\u003e\u003e) =\u003e {\r\n\t\tif (!res) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (Object.prototype.hasOwnProperty.call(res.data, \"token\")) {\r\n\t\t\tsessionStorage.setItem(\"token\", res.data.token as string);\r\n\t\t}\r\n\t\treturn res;\r\n\t},\r\n\t(err: AxiosError\u0026#x3C;{ errorMessage: string; success: boolean }\u003e) =\u003e {\r\n\t\t// handle the error\r\n\t\treturn Promise.reject(err);\r\n\t}\r\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e处理异常\u003c/h2\u003e\n\u003cp\u003e请求一个很重复的操作就是处理异常，一般来说异常都很有规律性，可分成业务操作错误导致的业务异常和由于请求失败导致的 HTTP 异常。\u003c/p\u003e\n\u003ch3\u003e业务异常\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eAxiosInstance\u003c/code\u003e 会返回一个 \u003ccode\u003ePromise\u003c/code\u003e，对于业务异常都是在 http returnCode 为 200 的时候。以 POST 请求为例子：\u003c/p\u003e\n\u003cp\u003e定义一个 标准的返回体：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eexport interface IResponse\u0026#x3C;T\u003e {\r\n\tdata: T;\r\n\terrorMessage: string;\r\n\tsuccess: boolean;\r\n\ttoken?: string;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e当返回 success 为 false 的时候，表示出现了业务异常。 由于是 Promise.then，可以在拦截器里面进行处理，也可以在实例返回中进行处理，这个地方如果不同的请求方法处理方式不同，就放到对应请求的实例里面去处理，反之就存在拦截器就可以。一般来说不同的请求方式返回的应是一致的：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eaxiosBase.interceptors.response.use(\r\n\t(res: AxiosResponse\u0026#x3C;IResponse\u0026#x3C;any\u003e\u003e) =\u003e {\r\n\t\tif (!res) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (!res.data.success) {\r\n\t\t\tnotify.warning(res.data.errorMessage);\r\n\t\t}\r\n\t\t// token...\r\n\t},\r\n\t(err: AxiosError\u0026#x3C;{ errorMessage: string; success: boolean }\u003e) =\u003e {\r\n\t\tnotify.error(err.response?.data.errorMessage as string);\r\n\t\tif (err.response?.status === 401 \u0026#x26;\u0026#x26; isNoAuth(window.location.pathname)) {\r\n\t\t\tsetTimeout(() =\u003e {\r\n\t\t\t\twindow.location.href = \"/person/login\";\r\n\t\t\t}, 1000);\r\n\t\t}\r\n\t\treturn Promise.reject(err);\r\n\t}\r\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ehttp error\u003c/h3\u003e\n\u003cp\u003e对于 http 的异常，为了能够在封装中对其进行统一处理，需要对实例返回的 Promise 进行二次封装，还是以 POST 请求为例：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst httpFuncs = {\r\n\tpost\u0026#x3C;T\u003e(\r\n\t\turl: string,\r\n\t\tdata: any,\r\n\t\tconfig?: AxiosRequestConfig\r\n\t): Promise\u0026#x3C;AxiosResponse\u0026#x3C;IResponse\u0026#x3C;T\u003e\u003e\u003e {\r\n\t\treturn new Promise((resolve, reject) =\u003e {\r\n\t\t\taxiosInstance\r\n\t\t\t\t.post(url, data, config)\r\n\t\t\t\t.then((res: AxiosResponse\u0026#x3C;IResponse\u0026#x3C;T\u003e\u003e) =\u003e resolve(res))\r\n\t\t\t\t// http error\r\n\t\t\t\t.catch((err: AxiosError\u0026#x3C;IErrorProps\u003e) =\u003e {\r\n\t\t\t\t\tconsole.log(err.response);\r\n\t\t\t\t});\r\n\t\t});\r\n\t},\r\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e在 \u003ccode\u003ePromise.catch\u003c/code\u003e中，处理返回的 http error， 主要是 401 和其他的 500 错误，这样就无需在具体的业务中关心这些异常的处理了。\u003c/p\u003e\n\u003ch2\u003eMore\u003c/h2\u003e\n\u003cp\u003e到此，基本就是完成了对 \u003ccode\u003eaxios\u003c/code\u003e 等请求库的常规封装。\u003c/p\u003e\n\u003ch3\u003e设计模式？\u003c/h3\u003e\n\u003cp\u003e或许可以使用一个 httpFactory 来对 http 请求进行统一的管理，这样就不会在从 mock 升级到正式的情况都时候，要到每一个实例里面去修改了。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eenum enumType {\r\n\tBASE,\r\n\tMOCK,\r\n}\r\n\r\nexport class HttpFactory {\r\n\tpublic static getHttp(type: enumType) {\r\n\t\tswitch (type) {\r\n\t\t\tcase enumType.BASE:\r\n\t\t\t\treturn http;\r\n\t\t\tcase enumType.MOCK:\r\n\t\t\t\treturn httpMock;\r\n\t\t\tdefault:\r\n\t\t\t\treturn http;\r\n\t\t}\r\n\t}\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用的时候就直接使用 \u003ccode\u003eHttpFactory.getHttp(enumType.MOCK).post\u0026#x3C;IUserInfo\u003e('/userinfo')\u003c/code\u003e, 这样升级的时候，直接把枚举修改一下即可。\u003c/p\u003e\n\u003cp\u003e实际生产中，可以使用配置文件来写这个枚举，这样就可以做到统一的管理。\u003c/p\u003e\n\u003ch2\u003eEnd\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"\"\u003e在线演示\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e总的来说最适合应用的才是最好的，本文只是介绍了我们在改造为 ts + axios + next.js 时候的经验，事实上对于 next.js，可以使用 \u003ca href=\"https://swr.vercel.app\"\u003euseSWR\u003c/a\u003e 等库，也进行了很好的封装。\u003c/p\u003e\n\u003ch2\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://segmentfault.com/a/1190000021071492\"\u003e比较 fetch()和 Axios\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6968630178163458084\"\u003e完整的 Axios 封装-单独 API 管理层、参数序列化、取消重复请求、Loading、状态码...\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/7053471988752318472\"\u003e封装 Axios 只看这一篇文章就行了\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6969070102868131853#heading-4\"\u003e错误处理 - 最后的完善\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://segmentfault.com/a/1190000021769678\"\u003evue+ts 下对 axios 的封装\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.cnblogs.com/double-W/p/12875623.html\"\u003eTS 泛型接口\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://markdowner.net/article/153598623580815360\"\u003e如何使用装饰器模式极大地增强 fetch()\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","coverImage":"/assets/blog/axios.jpg"}},"__N_SSG":true},"page":"/tech/[slug]","query":{"slug":"axios-wrapping"},"buildId":"Q5-ARss9H4OnstBP8NDja","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>