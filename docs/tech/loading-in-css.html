<!DOCTYPE html><html lang="en"><head><link rel="stylesheet" href="/style/index.css"/><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&amp;display=swap"/><script async="" defer="" data-website-id="3890bdd6-8ff5-4da5-8b72-45ba24876897" src="https://umami-alfxjx.up.railway.app/umami.js"></script><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/2649b9740f492fab27ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2649b9740f492fab27ec.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8fa755d3830e88407993.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8fa755d3830e88407993.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-6c6eb080c4d41d8fd79b.js" defer=""></script><script src="/_next/static/chunks/main-4fc50673e5500481d568.js" defer=""></script><script src="/_next/static/chunks/pages/_app-075949e5fa5ffddc911e.js" defer=""></script><script src="/_next/static/chunks/252f366e-b63e9f131b12ce609c69.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-b8804bb07d4f86914404.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-eb29eaaad2b07bc95110.js" defer=""></script><script src="/_next/static/chunks/1a48c3c1-63272919e4bbaae4097e.js" defer=""></script><script src="/_next/static/chunks/608-bb5bf9a1b1d10ad22ac0.js" defer=""></script><script src="/_next/static/chunks/553-f50d93340fc41d40714e.js" defer=""></script><script src="/_next/static/chunks/307-d4f637d0181fb2085729.js" defer=""></script><script src="/_next/static/chunks/pages/tech/%5Bslug%5D-6a6947d46afa43b14f3e.js" defer=""></script><script src="/_next/static/Q5-ARss9H4OnstBP8NDja/_buildManifest.js" defer=""></script><script src="/_next/static/Q5-ARss9H4OnstBP8NDja/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap">@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrFJM.woff) format('woff')}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9V1g.woff) format('woff')}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJbecnFHGPezSQ.woff2) format('woff2');unicode-range:U+0900-097F,U+1CD0-1CF6,U+1CF8-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FB}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJnecnFHGPezSQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJfecnFHGPc.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z11lFd2JQEl8qw.woff2) format('woff2');unicode-range:U+0900-097F,U+1CD0-1CF6,U+1CF8-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FB}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1JlFd2JQEl8qw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFd2JQEk.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="Post__Wrapper-sc-q8sq7-0 dzXARM"><div class="ProgressBar__FixedTopWrapper-sc-1ufpd9c-0 ProgressBar__ProgressBarWrapperFixed-sc-1ufpd9c-1 lmAxqe ketkUq"><div class="bar-used"></div></div><div class="header"><div class="icon-wrapper"><div class="icons"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 11H6.414l5.293-5.293-1.414-1.414L2.586 12l7.707 7.707 1.414-1.414L6.414 13H21z"></path></svg></div><div class="icons"><a href="/tech"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m7.375 16.781 1.25-1.562L4.601 12l4.024-3.219-1.25-1.562-5 4a1 1 0 0 0 0 1.562l5 4zm9.25-9.562-1.25 1.562L19.399 12l-4.024 3.219 1.25 1.562 5-4a1 1 0 0 0 0-1.562l-5-4zm-1.649-4.003-4 18-1.953-.434 4-18z"></path></svg></a></div></div></div><div class="toggle"><button class="switch__SwitchWrapper-sc-19ps08m-0 eMIOez"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path></svg><div class="round"></div></button></div><div style="height:3.25rem"></div><div class="Post-sc-1u8x57o-0 Post__PostWrapper-sc-q8sq7-1 hcSpXI fqyuhB"><div class="info"><h1>[CSS]矩形进度条的两种实现</h1><div class="user"><img class="img" src="/assets/authors/alfxjx.jpg" alt="Alfxjx"/><span class="title">Alfxjx</span><div class="date">2021-07-20</div></div></div><div class="post"><p>最近开发接到一个需求，前端展示付款的验证码，验证码时效 10 分钟，到期过期，同时在二维码的外侧有一个倒计时条，原本的实现方式是通过 JS 来控制，设置左上，左下，右上，右下四个矩形，每个矩形只显示一个折角的边框，从而模拟整个外框。</p>
<p>根据倒计时的时间轮询计算比例，分别控制四个矩形的宽高，从而实现倒计时的 <code>CountDown</code> 效果。这样的实现方式有几个问题：</p>
<ol>
<li>使用4个元素来模拟，导致加入了很多不必要的数据</li>
<li>js 轮询操作，代码很冗长。</li>
</ol>
<p>本文主要介绍两种非 js 控制的矩形倒计时条的实现方法。</p>
<h2>CSS 实现</h2>
<p>css 实现方法的原理是：</p>
<ol>
<li>设置四个<code>background</code>，使用<code>linear-gradient</code> 形成纯色的图片背景。</li>
<li>设置background的 <code>size</code> &#x26; <code>position</code>，使他们分布在元素的四周。</li>
<li>设置一个动画，均分成 4 个阶段，每个阶段将背景的位置按照顺时针平移。</li>
</ol>
<p>具体可以看代码</p>
<pre><code>.progress {
  display: flex;
  justify-content: center;
  align-items: center;
  height: var(--height);
  width: var(--width);
  border-radius: calc(var(--line) / 2);
  background: 
    linear-gradient(to right, var(--green) 99.99%, var(--blue))
    calc(-1 * var(--width)) 0rem 
    / 100% var(--line),
    linear-gradient(to bottom, var(--green) 99.99%, var(--blue))
    calc(var(--width) - var(--line)) calc(-1 * var(--height)) 
    / var(--line) 100%,
    linear-gradient(to right, var(--green) 99.99%, var(--blue)) 
    var(--width) calc(var(--height) - var(--line)) 
    / 100% var(--line),
    linear-gradient(to top, var(--green), 99.99%, var(--blue)) 
    0rem var(--height) 
    / var(--line) 100%;
  background-repeat: no-repeat;
  animation: progress var(--time) linear forwards infinite;
}

@keyframes progress {
  0% {
    background-position: 
      calc(-1 * var(--width)) 0rem,
      calc(var(--width) - var(--line)) calc(-1 * var(--height)),
      var(--width) calc(var(--height) - var(--line)), 
      0rem var(--height);
  }
  25% {
    background-position: 
      0rem 0rem,
      calc(var(--width) - var(--line)) calc(-1 * var(--height)),
      var(--width) calc(var(--height) - var(--line)), 
      0rem var(--height);
  }
  50% {
    background-position: 
      0rem 0rem, 
      calc(var(--width) - var(--line)) 0rem,
      var(--width) calc(var(--height) - var(--line)), 
      0rem var(--height);
  }
  75% {
    background-position: 
      0rem 0rem, 
      calc(var(--width) - var(--line)) 0rem,
      0rem calc(var(--height) - var(--line)), 
      0rem var(--height);
  }
  100% {
    background-position: 
      0rem 0rem, 
      calc(var(--width) - var(--line)) 0rem,
      0rem calc(var(--height) - var(--line)), 
      0rem 0rem;
  }
}

</code></pre>
<h2>SVG 实现</h2>
<p><code>svg</code>的实现则是hack了<code>stroke-dasharray</code>利用这个属性造出间断线来模拟倒计时，只要这个线足够长那么从视觉来看就是可以形成从全满变成全空的效果，这里的代码是这样的：</p>
<pre><code>&#x3C;div class="father">
  &#x3C;svg class="progressSvg" style={{'--speed': speed, '--progress': progress}} viewBox="0 0 120 120">
    &#x3C;rect width="100" height="100" x="10" y="10" rx="10" ry="10" />
  &#x3C;/svg>
  &#x3C;span class="son">{props.svg}&#x3C;/span>
&#x3C;/div>
</code></pre>
<p>主要看rect部分，设置了一个圆角，所以矩形的起始位置设置成了<code>x="10" y="10"</code>，并且由于设置了矩形的尺寸，为了能放下，所以 <code>svg</code> 标签的 <code>viewBox="0 0 120 120"</code> 从而放下这个圆角矩形。</p>
<p>这样以来，矩形的周长就是 400，所以设置<code>stroke-dasharray</code> 只要大于 400 即可，为了保险设置成 1000长度的实线，1000长度的虚线。</p>
<pre><code>.progressSvg rect {
  fill: none;
  stroke: blue;
  stroke-width: 4; // 控制边框的宽度
  /* 	stroke-linecap: round; */
  stroke-dasharray: 1000 1000;
  stroke-dashoffset: 0;
  animation: spin 60s infinite linear;
}

</code></pre>
<p>接着就是让它动起来，这里使用的是控制<code>stroke-offset</code>来控制，就从0（完全是边框）转到 -400（旋转了所有的边框），因为实线的前面是虚线，只要开始设置负的 <code>offset</code> 那么就会是类似于被吃掉的效果。</p>
<pre><code>@keyframes spin {
  to {
    stroke-dashoffset: -400;
  }
}
</code></pre>
<p>这样我们就实现了最简单的二维码倒计时进度条了。<a href="https://codepen.io/alfxjx/pen/jOBPeqX?editors=0010">在线演示 codepen.io</a></p>
<h2>组件化 基于 React</h2>
<p>样式基本不需要修改，修改一下js 文件，主要通过 css 变量来对倒计时时间，进度进行控制。</p>
<p>这里根据需求：</p>
<ol>
<li>页面在加载的时候会给出过期时间，例如总共支付时间10分钟的话，当进度条走了 60% 之后，进度条颜色变成红色。</li>
<li>根据给出的过期时间，页面刷新的时候，保持当前的进度。</li>
</ol>
<pre><code>const CountedDown = (props) => {
  const [color, setColor] = React.useState("green");
  const [speed, setSpeed] = React.useState('100s');
  const [progress] = React.useState('0.75');
  return (
    &#x3C;div>
      &#x3C;div class="flex" style={{ "--bg": color, "--time": speed }}>
        &#x3C;div class="countdown">
          &#x3C;div class="progress">
            &#x3C;div class="inner">
              {props.css}
            &#x3C;/div>
          &#x3C;/div>
        &#x3C;/div>
      &#x3C;/div>
      &#x3C;div class="father">
        &#x3C;svg class="progressSvg" style={{'--speed': speed, '--progress': progress}} viewBox="0 0 120 120">
          &#x3C;rect width="100" height="100" x="10" y="10" rx="10" ry="10" />
        &#x3C;/svg>
        &#x3C;span class="son">{props.svg}&#x3C;/span>
      &#x3C;/div>
    &#x3C;/div>
  );
}  
</code></pre>
<p>从上面的代码中，可以看出我们给 <code>css</code> 传入了 <code>--bg</code> 控制进度条的颜色，<code>--time</code>控制倒计时，读者可以自行查看在线演示代码。由于css版本的拐角存在问题，主要介绍svg版本。</p>
<p>在 svg 版本中， 传入了 <code>--speed</code> 控制速度，<code>--progress</code>控制进度，对应的 css :</p>
<pre><code>.progressSvg rect {
  fill: none;
  stroke: blue;
  stroke-width: 4;
  /* 	stroke-linecap: round; */
  stroke-dasharray: 1000 1000;
  - stroke-dashoffset: 0;
  - animation: spin 60s infinite linear;
  + stroke-dashoffset: calc((1 - var(--progress)) * (-400));
  + animation: spin var(--speed) infinite linear;
}
</code></pre>
<p><code>--speed</code>很好理解，主要解释<code>--progress</code>，上文中，我们知道使用动画就是让 <code>stroke-offset</code>按照逆时针旋转到 -400， 那么保存进度就是保存这个 offset 值，当我们认为现在的百分比进度是0.75的话，就需要提前 <strong>手动spin</strong> <code>(1-0.75)*(-400)</code> 。</p>
<p>可以用于生产的 React 组件 可以参考下面的代码：</p>
<pre><code>/* CountDown.module.css */
.father {
  position: relative;
}
.son {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 12rem;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.progress {
  width: 100%;
  height: 100%;
}

@keyframes spin {
  to {
    stroke-dashoffset: -400;
  }
}

.progress rect {
  fill: none;
  stroke: var(--color);
  stroke-width: 4;
  /* 	stroke-linecap: round; */
  stroke-dasharray: 1000 1000;
  stroke-dashoffset: calc(-400 * var(--rate));
  animation: spin 600s infinite linear;
  /*   animation-direction: alternate; */
}
</code></pre>
<pre><code>import React from 'react';

import styles from './CountDown.module.css';

interface MyCSSProperties extends React.CSSProperties {
  '--color': string;
  '--rate': string;
}

const CountDown = ({
  color,
  timer,
  children,
}: {
  color: string;
  timer: number;
  children: React.ReactNode;
}) => {
  const style: MyCSSProperties = {
    // Add a CSS Custom Property
    '--color': color,
    '--rate': `${1 - timer / (600 * 1000)}`,
  };

  return (
    &#x3C;div className={styles.father}>
      &#x3C;svg className={styles.progress} viewBox="0 0 120 120">
        &#x3C;rect style={style} width="100" height="100" x="10" y="10" rx="6" ry="6" />
      &#x3C;/svg>
      &#x3C;span className={styles.son}>{children}&#x3C;/span>
    &#x3C;/div>
  );
};

export { CountDown };

</code></pre>
<pre><code>/* usage */
import { useCountDown } from 'ahooks';
import React, { useEffect, useState } from 'react';

const Index = ()=>{
  const [barColor, setBarColor] = useState('blue'); // red
  const [expiryTimer, setTargetDate, formattedRes] = useCountDown({
    targetDate: dataRes.expiredAt,
    onEnd,
  });
  useEffect(() => {
    if (timer !== 0 &#x26;&#x26; timer &#x3C; 600 * 0.35 * 1000) {
      setBarColor('red');
    }
  }, [expiryTimer]);
  return (
  &#x3C;CountDown color={barColor} timer={timer}>
    &#x3C;div
      className={classNames({
        hidden: show,
      })}
      id="qrcode"
      ref={qrcodeRef}
      />
  &#x3C;/CountDown>
  )
}
</code></pre>
</div><div id="comments"></div></div><div class="Footer__FooterWrapper-sc-1ysspqt-0 bPlNKY"><div class="my-main-font text"><span>Powerd by <a href="https://nextjs.org">Next.js</a> on<!-- --> <a href="https://vercel.com">Vercel</a> with ♥ 2020-<!-- -->2022</span></div><div class="Footer__IconList-sc-1ysspqt-1 fShAcK"><a href="https://github.com/alfxjx"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://twitter.com/alfxjx"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://weibo.com/u/1950371745"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"></path></svg></a><a href="https://juejin.cn/user/2330620383728551"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.445 21.832a1 1 0 0 0 1.11 0l9-6A.998.998 0 0 0 21.8 14.4l-9-12c-.377-.504-1.223-.504-1.6 0l-9 12a1 1 0 0 0 .245 1.432l9 6zM13 19.131V6l6.565 8.754L13 19.131zM11 6v13.131l-6.565-4.377L11 6z"></path></svg></a><a href="https://umami-alfxjx.up.railway.app/share/eaSooCGG/Blog"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M181.9 256.1c-5-16-4.9-46.9-2-46.9 8.4 0 7.6 36.9 2 46.9zm-1.7 47.2c-7.7 20.2-17.3 43.3-28.4 62.7 18.3-7 39-17.2 62.9-21.9-12.7-9.6-24.9-23.4-34.5-40.8zM86.1 428.1c0 .8 13.2-5.4 34.9-40.2-6.7 6.3-29.1 24.5-34.9 40.2zM248 160h136v328c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V24C0 10.7 10.7 0 24 0h200v136c0 13.2 10.8 24 24 24zm-8 171.8c-20-12.2-33.3-29-42.7-53.8 4.5-18.5 11.6-46.6 6.2-64.2-4.7-29.4-42.4-26.5-47.8-6.8-5 18.3-.4 44.1 8.1 77-11.6 27.6-28.7 64.6-40.8 85.8-.1 0-.1.1-.2.1-27.1 13.9-73.6 44.5-54.5 68 5.6 6.9 16 10 21.5 10 17.9 0 35.7-18 61.1-61.8 25.8-8.5 54.1-19.1 79-23.2 21.7 11.8 47.1 19.5 64 19.5 29.2 0 31.2-32 19.7-43.4-13.9-13.6-54.3-9.7-73.6-7.2zM377 105L279 7c-4.5-4.5-10.6-7-17-7h-6v128h128v-6.1c0-6.3-2.5-12.4-7-16.9zm-74.1 255.3c4.1-2.7-2.5-11.9-42.8-9 37.1 15.8 42.8 9 42.8 9z"></path></svg></a><a href="/xujianxiang-resume.pdf"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-5h2v5zm4 0h-2v-3h2v3zm0-5h-2v-2h2v2zm4 5h-2V7h2v10z"></path></svg></a></div></div></div><div class="Toast__StyledContainer-sc-1p228qg-0 gWqgDn"><div class="Toastify"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"[CSS]矩形进度条的两种实现","date":"2021-07-19T20:35:07.322Z","slug":"loading-in-css","author":{"name":"Alfxjx","picture":"/assets/authors/alfxjx.jpg"},"content":"\u003cp\u003e最近开发接到一个需求，前端展示付款的验证码，验证码时效 10 分钟，到期过期，同时在二维码的外侧有一个倒计时条，原本的实现方式是通过 JS 来控制，设置左上，左下，右上，右下四个矩形，每个矩形只显示一个折角的边框，从而模拟整个外框。\u003c/p\u003e\n\u003cp\u003e根据倒计时的时间轮询计算比例，分别控制四个矩形的宽高，从而实现倒计时的 \u003ccode\u003eCountDown\u003c/code\u003e 效果。这样的实现方式有几个问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e使用4个元素来模拟，导致加入了很多不必要的数据\u003c/li\u003e\n\u003cli\u003ejs 轮询操作，代码很冗长。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e本文主要介绍两种非 js 控制的矩形倒计时条的实现方法。\u003c/p\u003e\n\u003ch2\u003eCSS 实现\u003c/h2\u003e\n\u003cp\u003ecss 实现方法的原理是：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e设置四个\u003ccode\u003ebackground\u003c/code\u003e，使用\u003ccode\u003elinear-gradient\u003c/code\u003e 形成纯色的图片背景。\u003c/li\u003e\n\u003cli\u003e设置background的 \u003ccode\u003esize\u003c/code\u003e \u0026#x26; \u003ccode\u003eposition\u003c/code\u003e，使他们分布在元素的四周。\u003c/li\u003e\n\u003cli\u003e设置一个动画，均分成 4 个阶段，每个阶段将背景的位置按照顺时针平移。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e具体可以看代码\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e.progress {\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  height: var(--height);\r\n  width: var(--width);\r\n  border-radius: calc(var(--line) / 2);\r\n  background: \r\n    linear-gradient(to right, var(--green) 99.99%, var(--blue))\r\n    calc(-1 * var(--width)) 0rem \r\n    / 100% var(--line),\r\n    linear-gradient(to bottom, var(--green) 99.99%, var(--blue))\r\n    calc(var(--width) - var(--line)) calc(-1 * var(--height)) \r\n    / var(--line) 100%,\r\n    linear-gradient(to right, var(--green) 99.99%, var(--blue)) \r\n    var(--width) calc(var(--height) - var(--line)) \r\n    / 100% var(--line),\r\n    linear-gradient(to top, var(--green), 99.99%, var(--blue)) \r\n    0rem var(--height) \r\n    / var(--line) 100%;\r\n  background-repeat: no-repeat;\r\n  animation: progress var(--time) linear forwards infinite;\r\n}\r\n\r\n@keyframes progress {\r\n  0% {\r\n    background-position: \r\n      calc(-1 * var(--width)) 0rem,\r\n      calc(var(--width) - var(--line)) calc(-1 * var(--height)),\r\n      var(--width) calc(var(--height) - var(--line)), \r\n      0rem var(--height);\r\n  }\r\n  25% {\r\n    background-position: \r\n      0rem 0rem,\r\n      calc(var(--width) - var(--line)) calc(-1 * var(--height)),\r\n      var(--width) calc(var(--height) - var(--line)), \r\n      0rem var(--height);\r\n  }\r\n  50% {\r\n    background-position: \r\n      0rem 0rem, \r\n      calc(var(--width) - var(--line)) 0rem,\r\n      var(--width) calc(var(--height) - var(--line)), \r\n      0rem var(--height);\r\n  }\r\n  75% {\r\n    background-position: \r\n      0rem 0rem, \r\n      calc(var(--width) - var(--line)) 0rem,\r\n      0rem calc(var(--height) - var(--line)), \r\n      0rem var(--height);\r\n  }\r\n  100% {\r\n    background-position: \r\n      0rem 0rem, \r\n      calc(var(--width) - var(--line)) 0rem,\r\n      0rem calc(var(--height) - var(--line)), \r\n      0rem 0rem;\r\n  }\r\n}\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eSVG 实现\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003esvg\u003c/code\u003e的实现则是hack了\u003ccode\u003estroke-dasharray\u003c/code\u003e利用这个属性造出间断线来模拟倒计时，只要这个线足够长那么从视觉来看就是可以形成从全满变成全空的效果，这里的代码是这样的：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026#x3C;div class=\"father\"\u003e\r\n  \u0026#x3C;svg class=\"progressSvg\" style={{'--speed': speed, '--progress': progress}} viewBox=\"0 0 120 120\"\u003e\r\n    \u0026#x3C;rect width=\"100\" height=\"100\" x=\"10\" y=\"10\" rx=\"10\" ry=\"10\" /\u003e\r\n  \u0026#x3C;/svg\u003e\r\n  \u0026#x3C;span class=\"son\"\u003e{props.svg}\u0026#x3C;/span\u003e\r\n\u0026#x3C;/div\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e主要看rect部分，设置了一个圆角，所以矩形的起始位置设置成了\u003ccode\u003ex=\"10\" y=\"10\"\u003c/code\u003e，并且由于设置了矩形的尺寸，为了能放下，所以 \u003ccode\u003esvg\u003c/code\u003e 标签的 \u003ccode\u003eviewBox=\"0 0 120 120\"\u003c/code\u003e 从而放下这个圆角矩形。\u003c/p\u003e\n\u003cp\u003e这样以来，矩形的周长就是 400，所以设置\u003ccode\u003estroke-dasharray\u003c/code\u003e 只要大于 400 即可，为了保险设置成 1000长度的实线，1000长度的虚线。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e.progressSvg rect {\r\n  fill: none;\r\n  stroke: blue;\r\n  stroke-width: 4; // 控制边框的宽度\r\n  /* \tstroke-linecap: round; */\r\n  stroke-dasharray: 1000 1000;\r\n  stroke-dashoffset: 0;\r\n  animation: spin 60s infinite linear;\r\n}\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e接着就是让它动起来，这里使用的是控制\u003ccode\u003estroke-offset\u003c/code\u003e来控制，就从0（完全是边框）转到 -400（旋转了所有的边框），因为实线的前面是虚线，只要开始设置负的 \u003ccode\u003eoffset\u003c/code\u003e 那么就会是类似于被吃掉的效果。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e@keyframes spin {\r\n  to {\r\n    stroke-dashoffset: -400;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样我们就实现了最简单的二维码倒计时进度条了。\u003ca href=\"https://codepen.io/alfxjx/pen/jOBPeqX?editors=0010\"\u003e在线演示 codepen.io\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e组件化 基于 React\u003c/h2\u003e\n\u003cp\u003e样式基本不需要修改，修改一下js 文件，主要通过 css 变量来对倒计时时间，进度进行控制。\u003c/p\u003e\n\u003cp\u003e这里根据需求：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e页面在加载的时候会给出过期时间，例如总共支付时间10分钟的话，当进度条走了 60% 之后，进度条颜色变成红色。\u003c/li\u003e\n\u003cli\u003e根据给出的过期时间，页面刷新的时候，保持当前的进度。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode\u003econst CountedDown = (props) =\u003e {\r\n  const [color, setColor] = React.useState(\"green\");\r\n  const [speed, setSpeed] = React.useState('100s');\r\n  const [progress] = React.useState('0.75');\r\n  return (\r\n    \u0026#x3C;div\u003e\r\n      \u0026#x3C;div class=\"flex\" style={{ \"--bg\": color, \"--time\": speed }}\u003e\r\n        \u0026#x3C;div class=\"countdown\"\u003e\r\n          \u0026#x3C;div class=\"progress\"\u003e\r\n            \u0026#x3C;div class=\"inner\"\u003e\r\n              {props.css}\r\n            \u0026#x3C;/div\u003e\r\n          \u0026#x3C;/div\u003e\r\n        \u0026#x3C;/div\u003e\r\n      \u0026#x3C;/div\u003e\r\n      \u0026#x3C;div class=\"father\"\u003e\r\n        \u0026#x3C;svg class=\"progressSvg\" style={{'--speed': speed, '--progress': progress}} viewBox=\"0 0 120 120\"\u003e\r\n          \u0026#x3C;rect width=\"100\" height=\"100\" x=\"10\" y=\"10\" rx=\"10\" ry=\"10\" /\u003e\r\n        \u0026#x3C;/svg\u003e\r\n        \u0026#x3C;span class=\"son\"\u003e{props.svg}\u0026#x3C;/span\u003e\r\n      \u0026#x3C;/div\u003e\r\n    \u0026#x3C;/div\u003e\r\n  );\r\n}  \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e从上面的代码中，可以看出我们给 \u003ccode\u003ecss\u003c/code\u003e 传入了 \u003ccode\u003e--bg\u003c/code\u003e 控制进度条的颜色，\u003ccode\u003e--time\u003c/code\u003e控制倒计时，读者可以自行查看在线演示代码。由于css版本的拐角存在问题，主要介绍svg版本。\u003c/p\u003e\n\u003cp\u003e在 svg 版本中， 传入了 \u003ccode\u003e--speed\u003c/code\u003e 控制速度，\u003ccode\u003e--progress\u003c/code\u003e控制进度，对应的 css :\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e.progressSvg rect {\r\n  fill: none;\r\n  stroke: blue;\r\n  stroke-width: 4;\r\n  /* \tstroke-linecap: round; */\r\n  stroke-dasharray: 1000 1000;\r\n  - stroke-dashoffset: 0;\r\n  - animation: spin 60s infinite linear;\r\n  + stroke-dashoffset: calc((1 - var(--progress)) * (-400));\r\n  + animation: spin var(--speed) infinite linear;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e--speed\u003c/code\u003e很好理解，主要解释\u003ccode\u003e--progress\u003c/code\u003e，上文中，我们知道使用动画就是让 \u003ccode\u003estroke-offset\u003c/code\u003e按照逆时针旋转到 -400， 那么保存进度就是保存这个 offset 值，当我们认为现在的百分比进度是0.75的话，就需要提前 \u003cstrong\u003e手动spin\u003c/strong\u003e \u003ccode\u003e(1-0.75)*(-400)\u003c/code\u003e 。\u003c/p\u003e\n\u003cp\u003e可以用于生产的 React 组件 可以参考下面的代码：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e/* CountDown.module.css */\r\n.father {\r\n  position: relative;\r\n}\r\n.son {\r\n  position: absolute;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  width: 12rem;\r\n  height: 100%;\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n}\r\n\r\n.progress {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n\r\n@keyframes spin {\r\n  to {\r\n    stroke-dashoffset: -400;\r\n  }\r\n}\r\n\r\n.progress rect {\r\n  fill: none;\r\n  stroke: var(--color);\r\n  stroke-width: 4;\r\n  /* \tstroke-linecap: round; */\r\n  stroke-dasharray: 1000 1000;\r\n  stroke-dashoffset: calc(-400 * var(--rate));\r\n  animation: spin 600s infinite linear;\r\n  /*   animation-direction: alternate; */\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eimport React from 'react';\r\n\r\nimport styles from './CountDown.module.css';\r\n\r\ninterface MyCSSProperties extends React.CSSProperties {\r\n  '--color': string;\r\n  '--rate': string;\r\n}\r\n\r\nconst CountDown = ({\r\n  color,\r\n  timer,\r\n  children,\r\n}: {\r\n  color: string;\r\n  timer: number;\r\n  children: React.ReactNode;\r\n}) =\u003e {\r\n  const style: MyCSSProperties = {\r\n    // Add a CSS Custom Property\r\n    '--color': color,\r\n    '--rate': `${1 - timer / (600 * 1000)}`,\r\n  };\r\n\r\n  return (\r\n    \u0026#x3C;div className={styles.father}\u003e\r\n      \u0026#x3C;svg className={styles.progress} viewBox=\"0 0 120 120\"\u003e\r\n        \u0026#x3C;rect style={style} width=\"100\" height=\"100\" x=\"10\" y=\"10\" rx=\"6\" ry=\"6\" /\u003e\r\n      \u0026#x3C;/svg\u003e\r\n      \u0026#x3C;span className={styles.son}\u003e{children}\u0026#x3C;/span\u003e\r\n    \u0026#x3C;/div\u003e\r\n  );\r\n};\r\n\r\nexport { CountDown };\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003e/* usage */\r\nimport { useCountDown } from 'ahooks';\r\nimport React, { useEffect, useState } from 'react';\r\n\r\nconst Index = ()=\u003e{\r\n  const [barColor, setBarColor] = useState('blue'); // red\r\n  const [expiryTimer, setTargetDate, formattedRes] = useCountDown({\r\n    targetDate: dataRes.expiredAt,\r\n    onEnd,\r\n  });\r\n  useEffect(() =\u003e {\r\n    if (timer !== 0 \u0026#x26;\u0026#x26; timer \u0026#x3C; 600 * 0.35 * 1000) {\r\n      setBarColor('red');\r\n    }\r\n  }, [expiryTimer]);\r\n  return (\r\n  \u0026#x3C;CountDown color={barColor} timer={timer}\u003e\r\n    \u0026#x3C;div\r\n      className={classNames({\r\n        hidden: show,\r\n      })}\r\n      id=\"qrcode\"\r\n      ref={qrcodeRef}\r\n      /\u003e\r\n  \u0026#x3C;/CountDown\u003e\r\n  )\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n","coverImage":"/assets/blog/css-loading.png"}},"__N_SSG":true},"page":"/tech/[slug]","query":{"slug":"loading-in-css"},"buildId":"Q5-ARss9H4OnstBP8NDja","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>