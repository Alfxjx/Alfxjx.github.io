<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/6ac04af9c34471e28ed7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6ac04af9c34471e28ed7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8fa755d3830e88407993.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8fa755d3830e88407993.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d4ca226b082815b6b5f.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/main-f388e32f9dd9c15fe4aa.js" defer=""></script><script src="/_next/static/chunks/pages/_app-195005c5a9d38cc7d564.js" defer=""></script><script src="/_next/static/chunks/852-2043476d938a0a39d6e5.js" defer=""></script><script src="/_next/static/chunks/198-3763d6730efee10d33d3.js" defer=""></script><script src="/_next/static/chunks/pages/tech/%5Bslug%5D-789eabd0a4ce48bf050e.js" defer=""></script><script src="/_next/static/tDsM1wHyHGJqsCwdxqJTA/_buildManifest.js" defer=""></script><script src="/_next/static/tDsM1wHyHGJqsCwdxqJTA/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="Post__Wrapper-sc-q8sq7-0 blKUxx"><div class="ProgressBar__ProgressBarWrapper-sc-1ufpd9c-0 gqWHWe"><div class="bar-used"></div></div><div class="header"><div class="icon-wrapper"><div class="icons"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M872 474H286.9l350.2-304c5.6-4.9 2.2-14-5.2-14h-88.5c-3.9 0-7.6 1.4-10.5 3.9L155 487.8c-14.7 12.8-14.7 35.6 0 48.3L535.1 866c1.5 1.3 3.3 2 5.2 2h91.5c7.4 0 10.8-9.2 5.2-14L286.9 550H872c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"></path></svg></div><div class="icons"><a href="/tech"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M541.141 268.864l61.718 16.939-132.395 482.474-61.717-16.938L541.14 268.864zm-212.138 29.803l44.885 45.61-175.36 172.587 175.04 167.573-44.267 46.23-222.634-213.163 222.336-218.837zm355.882 0l222.336 218.837-222.634 213.163-44.267-46.23 175.019-167.573L640 344.277l44.885-45.61z"></path></svg></a></div></div></div><div class="toggle"><button class="Button__InsideButton-sc-19071w6-0 cyRVLS"><div class="LightDarkSwitcher__Switcher-sc-hbms9j-0 cBdTSF"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M448 64v195.2a224.832 224.832 0 0 0-100.992 42.24L208.512 163.2l-45.248 45.312 138.24 138.496A218.624 218.624 0 0 0 259.008 448H64v64h195.008c5.504 37.76 20.48 72 42.496 100.992l-138.24 138.496 45.248 45.248L347.008 658.24C376 680 410.496 695.232 448 700.736V896h64V700.8a222.4 222.4 0 0 0 100.992-42.56l138.496 138.496 45.248-45.248L658.24 612.992A216.32 216.32 0 0 0 700.992 512H896v-64H700.992a216.32 216.32 0 0 0-42.752-100.992l138.496-138.496-45.248-45.248-138.496 138.24A224.832 224.832 0 0 0 512 259.2V64zm32 256c88.768 0 160 71.232 160 160s-71.232 160-160 160a159.488 159.488 0 0 1-160-160c0-88.768 71.232-160 160-160z"></path></svg></div></button></div><div style="height:3.25rem"></div><div class="Post-sc-1u8x57o-0 Post__PostWrapper-sc-q8sq7-1 fbyABu mIDzq"><div class="info"><h1>Next.js 项目迁移到 create-react-app</h1><div class="user"><img class="img" src="/assets/authors/alfxjx.jpg" alt="Alfxjx"/><span class="title">Alfxjx</span><div class="date">2021-09-21</div></div></div><div class="post"><p>公司的统一登录项目之前部署在私有云上采用的是 <code>next.js</code>，虽然存在一些问题但是还能使用。现在统一部署到公司自建的 devops 平台，由于平台只有通用的 <code>react</code> 流水线，部署之后是客户端渲染的类型（<code>CSR</code>），导致之前的服务端渲染部署上去存在很多问题，调整成 <code>SSG</code> 模式部署上去也存在很多问题，例如 <code>redux</code> 状态管理问题以及 <code>router</code> 跳转问题，针对这些问题，最终决定从 <code>next.js</code> 框架切换到 <code>create- react-app</code> 的客户端渲染模式。这个需求还是很奇葩的，网上搜了一圈也没这个先例，于是就写了此文记录一下迁移以及都 <code>CRA</code> 的一些配置。</p>
<h2>迁移目标</h2>
<p>原有的项目基于 next.js 使用了 next.js 的路由以及一些 <a href="https://www.nextjs.cn/docs/basic-features/data-fetching#getstaticprops-static-generation"><code>getStaticProps</code> (Static Generation)</a> 方法，要对其进行重写，首先是安装 CRA 脚手架，将页面迁移过去，然后再配置 <code>react-router-dom</code>, <code>react-redux-toolkit</code> 等，最后在配置一下 <code>typescript</code> 的开发环境。</p>
<h2>安装脚手架 create- react-app</h2>
<pre><code class="language-shell"># 在项目的根目录
npx create-react-app my-app --typescript
</code></pre>
<p>这样就在根目录新建了一个项目，这里可以先把子项目 <code>/my-app/node_modules</code> 添加到 <code>.gitignore</code>.</p>
<p>后面安装依赖：</p>
<pre><code class="language-json">{
  "@reduxjs/toolkit": "^1.6.1",
  "react-redux": "^7.2.4",
	"react-router-dom": "^5.2.1",
  "redux": "^4.1.1",
  "@types/react-redux": "^7.1.18",
	"@types/react-router-dom": "^5.1.8",
}
</code></pre>
<h3>react-router-dom</h3>
<p>由于之前的 <code>next.js</code> 是约定式路由，改成使用  <code>react-router-dom</code>,  加之公司其他的项目都是使用的配置式的路由，所以需要对其进行改造，经过研究，在项目的 <code>index.tsx</code>引入路由，在 <code>App.tsx</code>中配置路由表。</p>
<pre><code class="language-shell">npm i -S react-router-dom
npm i -D @types/react-router-dom
</code></pre>
<pre><code class="language-tsx">import { HashRouter as Router } from 'react-router-dom';
ReactDOM.render(
		&#x3C;React.StrictMode>
			&#x3C;Router>
				&#x3C;App />
			&#x3C;/Router>
		&#x3C;/React.StrictMode>
  ,
	document.getElementById('root')
);
</code></pre>
<pre><code class="language-tsx">import { Route, Switch } from 'react-router-dom';
export default function App() {
  return (
		&#x3C;div className="App">
			&#x3C;Switch>
				&#x3C;Route path="/login" component={Login} />
				&#x3C;Route path="/oauth" component={Oauth} />
				&#x3C;Route path="/dashboard" component={Dashboard} />
			&#x3C;/Switch>
		&#x3C;/div>
	);
}
</code></pre>
<blockquote>
<p>这里的路由是直接写在里面，也可以配置一个 路由表 然后渲染成组件，这样更加解耦</p>
</blockquote>
<pre><code class="language-tsx">const configRoute = [
  {
    path:'/login', component: Oauth,
    ...
  }
];
return (
    &#x3C;Switch>
    	{configRoute.map(route)=>(
      	&#x3C;Route path={route.path}, component={route.component}>&#x3C;/Route>
      )}
    &#x3C;/Switch>
    );
</code></pre>
<p>对于 <code>next/router</code> 还有一个 <code>useRouter</code>， 可以使用 <code>useHistory</code> , <code>useLocation</code>来代替：</p>
<pre><code class="language-tsx">import { useHistory, useLocation } from 'react-router-dom';
function App() {
	const history = useHistory();
  // 获取搜索栏的地址
	const { search } = useLocation();
	useEffect(() => {
		if (search) {
			history.push(`/oauth${search}`);
		} else {
			history.push('/dashboard');
		}
	}, [history, search]);
	return (
		...
	);
}
</code></pre>
<p>这样一来 <code>next/router</code>  的功能就被代替了，下面配置 <code>react-redux</code> 进行状态管理。</p>
<h3>react-redux</h3>
<pre><code class="language-shell">npm i -S @reduxjs/toolkit react-redux redux
npm i -D @types/react-redux
</code></pre>
<p>首先是 <code>index.tsx</code></p>
<pre><code class="language-tsx">import { Provider } from 'react-redux';
import store from './store/store';

ReactDOM.render(
	&#x3C;Provider store={store}>
		&#x3C;App />
	&#x3C;/Provider>,
	document.getElementById('root')
);
</code></pre>
<p>配置的 store ：</p>
<pre><code class="language-ts">// store.ts
import { configureStore, ThunkAction, Action } from '@reduxjs/toolkit'
// 按照模块划分需要保存的状态
import userReducer from './modules/userSlice'
export function makeStore() {
  return configureStore({
    reducer: { user: userReducer },
  })
}

const store = makeStore()
// 导出类型
export type AppState = ReturnType&#x3C;typeof store.getState>
export type AppDispatch = typeof store.dispatch
export type AppThunk&#x3C;ReturnType = void> = ThunkAction&#x3C;
  ReturnType,
  AppState,
  unknown,
  Action&#x3C;string>
>
export default store

</code></pre>
<p>user 模块：</p>
<pre><code class="language-tsx">import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import type { AppState } from '@/store/store';

export interface UserState {
	userName: string;
}
// 创建一个初始的状态
const initialState: UserState = {
	userName: '',
};

export const userSlice = createSlice({
	name: 'user',
	initialState,
	reducers: {
    // 类似于 vuex mutations
		getUserInfo: (state, { payload }: PayloadAction&#x3C;UserState>) => {
			return payload;
		},
	},
});

export const { getUserInfo } = userSlice.actions;

export const selectUserName = (state: AppState) => state.user.userName;

export default userSlice.reducer;

</code></pre>
<p>另外 <code>react-redux</code> 还提供了几个hook 用于使用：</p>
<pre><code class="language-tsx">import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux';

import type { AppDispatch, AppState } from './store';

// Use throughout your app instead of plain `useDispatch` and `useSelector`
export const useAppDispatch = () => useDispatch&#x3C;AppDispatch>();

export const useAppSelector: TypedUseSelectorHook&#x3C;AppState> = useSelector;
</code></pre>
<p>使用方法可以看这个例子：</p>
<pre><code class="language-tsx">import { useAppDispatch } from '@/store/hooks';
import { getUserInfo } from '@/store/modules/userSlice';
const App = ()=>{
  const dispatch = useAppDispatch();
  const handleClick = (data)=>{
    dispatch(getUserInfo({ userInfo: data }));
  }
}
</code></pre>
<blockquote>
<p>对于 异步 actions 回头再研究研究</p>
</blockquote>
<h3>eject? customize-cra?</h3>
<p>上面的配置完成之后，对于之前使用的一些 alias， proxy 等还需要继续配置，这里有两种情况</p>
<ol>
<li>运行 <code>npm run eject</code> 弹出隐藏的 <code>webpack</code> 配置，在其中配置参数；</li>
<li>使用 <code>customize-cra</code> + <code>react-app-rewired</code> 进行个性化配置</li>
</ol>
<p>本次迁移中一开始选择使用第二种方法，<code>customize-cra</code> + <code>react-app-rewired</code> ，</p>
<pre><code class="language-js">const { useBabelRc, override } = require('customize-cra');
const { alias, configPaths } = require('react-app-rewire-alias');

const aliasMap = configPaths('./tsconfig.path.json')

console.log(__dirname);
const config = override(
	// eslint-disable-next-line
	useBabelRc(),
	alias(aliasMap)
);

module.exports = config;
</code></pre>
<p>但是后面发现每次配置的时候都需要去查对应的封装的包，有点麻烦于是索性 <code>eject</code> ，自由配置 <code>webpack </code> . <code>eject</code> 之后主要配置项就在 <code>/config</code> 目录下了，这里的配置大同小异，不会的小朋友可以去看看 《深入浅出webpack》.</p>
<p><code>eject</code>还带来了一个目录 <code>/scripts</code> 里面写了打包编译的脚本文件，一般不用动，有时间可以看下，在启动项目和打包的时候 <code>create-react-app</code>到底做了什么工作。</p>
<h2>去除 next.js 依赖</h2>
<p>脚手架安装完成之后就是对项目进行迁移，并把<code>next.js</code>相关的 类似于 <code>next/link</code>，<code>next/router</code>等依赖切换成对应的 <code>react-router-dom</code>的方法和包。</p>
<h2>配置 create-react-app 成为 react 开发环境</h2>
<ol>
<li>
<p>在 <code>.env</code> 文件里 以 <code>REACT_APP_</code> 开头配置地址等文件</p>
</li>
<li>
<p>创建 <code>/src/types/index.d.ts</code>  声明一些静态文件的类型</p>
</li>
</ol>
<pre><code class="language-typescript">  declare module '*.svg';
  declare module '*.png';
  declare module '*.jpg';
  declare module '*.jpeg';
  declare module '*.gif';
</code></pre>
<ol start="3">
<li>
<p>设置别名和 <code>baseUrl</code></p>
<ul>
<li>
<p>一个是在<code>webpack </code>里面设置，用于打包的时候，不过这里<code>create-react-app</code>的配置已经处理了，会读取项目中的<code>t/jsconfig.json</code> 文件里面的配置。</p>
</li>
<li>
<p>还有一个是在 <code>tsconfig.json</code> 设置，用于开发的时候在 ide 里面解析</p>
</li>
</ul>
<pre><code class="language-json">"baseUrl": "./",
"paths": {
	"@/*": ["./src/*"]
}
</code></pre>
</li>
</ol>
<h2>后记</h2>
<p>这个文章告诉我们的道理是，技术选型首先要慎重，根据项目的场景选择最合适的技术栈；其次是要选择熟悉的技术，否则后面的维护会受到影响；还有就是一旦遇到问题，当发现技术确实与现有的业务不匹配的时候，抓紧时间进行切换，减少沉默成本。</p>
</div><div id="comments"></div></div><div class="Footer__FooterWrapper-sc-1ysspqt-0 dduiPc"><div class="my-main-font text"><span>Powerd by Next.js on gh-pages, </span><a href="http://www.anbandon.work">More in old blog</a></div><div class="Footer__IconList-sc-1ysspqt-1 iXsBAW"><a href="https://github.com/alfxjx"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><defs><style></style></defs><path d="M960 512c0 97.76-28.704 185.216-85.664 263.264-56.96 78.016-130.496 131.84-220.64 161.856-10.304 1.824-18.368.448-22.848-4.032a22.4 22.4 0 0 1-7.2-17.504v-122.88c0-37.632-10.304-65.44-30.464-82.912a409.856 409.856 0 0 0 59.616-10.368 222.752 222.752 0 0 0 54.72-22.816c18.848-10.784 34.528-23.36 47.104-38.592 12.544-15.232 22.848-35.904 30.912-61.44 8.096-25.568 12.128-54.688 12.128-87.904 0-47.072-15.232-86.976-46.208-120.16 14.368-35.456 13.024-74.912-4.48-118.848-10.752-3.616-26.432-1.344-47.072 6.272s-38.56 16.16-53.824 25.568l-21.984 13.888C587.776 285.088 550.56 280.16 512 280.16s-75.776 4.928-112.096 15.232a444.48 444.48 0 0 0-24.672-15.68c-10.336-6.272-26.464-13.888-48.896-22.432-21.952-8.96-39.008-11.232-50.24-8.064-17.024 43.936-18.368 83.424-4.032 118.848-30.496 33.632-46.176 73.536-46.176 120.608 0 33.216 4.032 62.336 12.128 87.456 8.032 25.12 18.368 45.76 30.496 61.44 12.544 15.68 28.224 28.704 47.072 39.04 18.848 10.304 37.216 17.92 54.72 22.816a409.6 409.6 0 0 0 59.648 10.368c-15.712 13.856-25.12 34.048-28.704 60.064a99.744 99.744 0 0 1-26.464 8.512 178.208 178.208 0 0 1-33.184 2.688c-13.024 0-25.568-4.032-38.144-12.544-12.544-8.512-23.296-20.64-32.256-36.32a97.472 97.472 0 0 0-28.256-30.496c-11.232-8.064-21.088-12.576-28.704-13.92l-11.648-1.792c-8.096 0-13.92.928-17.056 2.688-3.136 1.792-4.032 4.032-2.688 6.72s3.136 5.408 5.376 8.096 4.928 4.928 7.616 7.168l4.032 2.688c8.544 4.032 17.056 11.232 25.568 21.984 8.544 10.752 14.368 20.64 18.4 29.6l5.824 13.44c4.928 14.816 13.44 26.912 25.568 35.872 12.096 8.992 25.088 14.816 39.008 17.504 13.888 2.688 27.36 4.032 40.352 4.032s23.776-.448 32.288-2.24l13.472-2.24c0 14.784 0 32.288.416 52.032 0 19.744.48 30.496.48 31.392a22.624 22.624 0 0 1-7.648 17.472c-4.928 4.48-12.992 5.824-23.296 4.032-90.144-30.048-163.68-83.84-220.64-161.888C92.256 697.216 64 609.312 64 512c0-81.152 20.192-156.064 60.096-224.672s94.176-122.88 163.232-163.232C355.936 84.192 430.816 64 512 64s156.064 20.192 224.672 60.096 122.88 94.176 163.232 163.232C939.808 355.488 960 430.848 960 512"></path></svg></a><a href="https://weibo.com/u/1950371745"><svg class="icon" viewBox="0 0 1026 1024" xmlns="http://www.w3.org/2000/svg" width="32.063" height="32"><defs><style></style></defs><path d="M0 61.5zM780 577c-11-2-18-5.5-21-9.5-3-4.5-4-8-1.5-12l3-5.5c.5-.5 1.5-2 2-3 .5-1.5 2-4.5 4.5-9 2-4.5 4-9.5 5-14s2-10.5 2.5-17 .5-13.5-.5-19.5-3-12.5-6.5-20c-3.5-7-7.5-13.5-13.5-19.5-10-10-23-16.5-39.5-19.5-16-3-32.5-3-48.5-.5s-31.5 5.5-45.5 9.5c-14.5 4-26 7.5-35.5 11.5l-14 6.5c-7 2-13 3.5-18 4.5-4.5.5-8.5.5-11-.5s-4.5-2-6-3-2-3.5-1.5-7.5.5-7.5 1-10c.5-3 1.5-7.5 2.5-13.5 1.5-6 2.5-11 3-14.5 0-8.5-.5-16.5-1.5-24s-3.5-16-7-25.5-9-17-15.5-22.5c-7-5.5-15.5-10.5-26-14s-24-4.5-40.5-3-35 5.5-56 13c-25 8.5-50.5 21.5-76.5 38-26 17-48 34.5-67 52.5-19 18.5-36.5 36-52 53.5-16 17-28 31-36.5 42l-12 17c-23.5 31-41 61.5-52.5 92.5s-17 54-16 70V723c4.5 34.5 15 65.5 31.5 92.5 17 27.5 37 49.5 60 66 23.5 17 51 31 82.5 43s62 20.5 91 26 59.5 9 92 11.5c53 4.5 108 0 165-12.5s110-34.5 159-65c49-31 84-68 104-111 12-25 18.5-49 19-71s-3.5-40.5-11.5-54.5-18-26.5-30.5-37c-12.5-11-24.5-18.5-35.5-23.5-10-6-20-9.5-28.5-10.5zM452 911.5c-77.5 3.5-143.5-11.5-197.5-45s-81-76.5-81-128c0-51 27-95 80.5-132s120-57 198-61S596 555 650 584s80.5 69.5 80.5 120.5c0 51.5-27.5 98-82.5 139.5s-120 64-196 67.5zm-31.5-298c-21 2-39.5 7-56 14.5S335 644 326 654c-9.5 9.5-17 20-23.5 31s-11 22-13.5 33-4 20.5-5 29.5c-.5 9-1 16-1 21l1 8.5v4.5c0 2 .5 6.5 2 13s3.5 12.5 6 18 6.5 11.5 12.5 18 12.5 12 20.5 16c47.5 23 91.5 30 132.5 21s74-29.5 99-62c10-12 16.5-27.5 20-45 3-18 2.5-36-2-54.5s-12.5-35-24-50-28.5-26.5-51-35c-23.5-9-49.5-11-79-7.5zM382 817c-4.5.5-8.5 1-12.5.5s-7.5-1-11-2-6.5-2.5-9.5-4-6-3.5-8-6l-6-7.5c-2-2.5-3-5.5-4.5-8.5s-1.5-6.5-1.5-10c0-8 2-15.5 6.5-23s10-14 18-19.5c7.5-5.5 16-8.5 25.5-9 6.5-.5 12.5-.5 19 .5 6 1 11.5 3 15.5 5.5 4.5 2.5 8 5.5 11.5 8.5 3 3 5.5 7 7 11.5s2 9 2 14c0 8-2.5 15.5-7 22.5S416 804 408 809c-8 4-16.5 7-26 8zm91.5-77.5c-5 3.5-10 5-15.5 5-5.5-.5-9-2.5-11.5-7l-2-4.5c-.5-1.5-1-3-1-4.5V724c0-2 .5-4 1-5.5l2-4.5c.5-1.5 2-2.5 3-3l3-4.5c5.5-4.5 11.5-6 16.5-5.5s9 3.5 11.5 8.5c2 3 3 6 2.5 9.5s-1.5 7-3 10c-1.5 4.5-4 7.5-6.5 10.5zm382-225c4.5 0 8.5-1 12-3s6.5-5 8.5-8 3.5-6.5 4.5-10c.5-.5 1-2 1-3 8.5-82-20-128.5-86-140-19.5-3.5-37.5-4-54-1-5 0-9.5 1.5-13 4s-6.5 5.5-9 9.5-4 8-4 12.5c0 7 2.5 13.5 7.5 18.5s11 7.5 18.5 7.5c56-13 86 5 90.5 54 1.5 12 .5 23.5-2 34.5 0 7 2.5 13.5 7.5 18.5 4.5 3.5 10.5 6 18 6zM837 211c-31.5-7-74-5.5-127 4.5-.5 0-1.5.5-2 1l-1 2-1 1c-8 2-14.5 6.5-19.5 13.5s-7.5 14-7.5 22c0 11 3.5 19.5 11 27 7 7 16 11 26 11h3c.5 0 2.5-.5 5-1s5-1.5 8-1.5c3-.5 6-1 9-2s6-2 8.5-3S757 284 764 284s16 .5 26.5 1.5 22 4 34.5 8c12.5 4.5 25 9.5 37.5 16s25 15.5 37.5 27 23.5 24.5 33 40c18.5 42.5 22.5 83 11 122.5 0 .5 0 1.5-.5 2s-1 2.5-1.5 5.5-1.5 5.5-2 8-1.5 5.5-2 9.5-1 7.5-1 10c0 6.5 2 12 5.5 16 3.5 4.5 8 7.5 13.5 9 5.5 2 11.5 2.5 19 2.5 20 0 32-12 35.5-36.5 8.5-28 13.5-54.5 14.5-80s-.5-48-5.5-67c-4.5-19.5-11.5-37.5-21-54.5s-20-31-32.5-43c-12-12-26-22.5-41-32.5-15-9.5-29.5-17.5-43.5-23-15-5.5-29.5-10.5-44.5-14z"></path></svg></a><a href="https://juejin.cn/user/2330620383728551"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><defs><style></style></defs><path d="M832 739.533h57.958v30.105H587.571v-30.105h48.538l-31.54-184.525-.819-4.506 4.608-.716 21.095-3.482 4.505-.717.82 4.506 32.46 189.645h49.87V510.874H571.391v-30.106h145.613V381.44H619.93v-30.106h228.556v30.106H747.52v99.328h162.918v30.106H747.622v228.659h53.453l32.461-189.543.717-4.505 4.505.717 21.095 3.481 4.608.717-.82 4.506L832 739.533zm-428.032-9.728V582.45h74.854V423.22h-30.617v129.127h-44.237V413.798H373.35v138.548h-43.52V423.219h-30.617v159.232h74.137v147.354h-43.52V602.624h-30.617V759.91H478.72V602.624h-30.618v127.18h-44.134zM148.89 582.45l-21.607 21.197-3.174 3.174-3.175-3.174L105.78 588.8l-3.379-3.277 3.38-3.277 43.11-42.393V364.237h-37.684V334.13h37.684V254.26h30.617v79.872h44.135v30.106h-44.135v145.715l25.6-25.088 3.175-3.174 3.174 3.174 15.155 14.746 3.38 3.276-3.38 3.277-47.104 46.285v65.024c0 33.178-5.12 65.024-13.824 94.413-5.325 18.022-10.547 31.13-14.745 39.629l-4.71 9.42-2.049 3.994-4.096-1.946-19.251-9.113-4.198-2.048 2.048-4.199 4.608-9.42c.716-1.332 2.252-4.813 3.993-9.319 2.97-7.475 5.94-15.974 8.704-25.497 7.885-26.932 12.698-56.013 12.698-86.016V582.45zm97.792 180.122l.921-4.506 2.15-10.24c12.8-61.645 17.511-195.584 16.999-358.605h220.672v-134.86H234.496l.102 4.71.205 10.65c.205 10.24.615 32.768.82 59.904.409 44.748.511 91.033.102 136.601-1.229 129.536-6.144 227.84-16.077 275.559l-2.15 10.24-.922 4.505 4.506.922 20.992 4.198 4.608.922zm19.865-403.456l-1.024-74.65h191.181v74.65H266.547zm634.266 31.437l3.072-3.277 14.54-15.36 3.175-3.38-3.482-3.174-121.344-109.875-3.072-1.229h-126.77l-3.073 1.229-121.241 109.875-3.482 3.175 3.174 3.379 14.541 15.36 3.072 3.277 3.38-2.97 115.2-103.014h103.833l115.2 103.014 3.277 2.97z"></path></svg></a></div></div></div><div class="Toast__StyledContainer-sc-1p228qg-0 iqCFQa"><div class="Toastify"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Next.js 项目迁移到 create-react-app","date":"2021-09-20T17:10:00.000Z","slug":"migrating-cra","author":{"name":"Alfxjx","picture":"/assets/authors/alfxjx.jpg"},"content":"\u003cp\u003e公司的统一登录项目之前部署在私有云上采用的是 \u003ccode\u003enext.js\u003c/code\u003e，虽然存在一些问题但是还能使用。现在统一部署到公司自建的 devops 平台，由于平台只有通用的 \u003ccode\u003ereact\u003c/code\u003e 流水线，部署之后是客户端渲染的类型（\u003ccode\u003eCSR\u003c/code\u003e），导致之前的服务端渲染部署上去存在很多问题，调整成 \u003ccode\u003eSSG\u003c/code\u003e 模式部署上去也存在很多问题，例如 \u003ccode\u003eredux\u003c/code\u003e 状态管理问题以及 \u003ccode\u003erouter\u003c/code\u003e 跳转问题，针对这些问题，最终决定从 \u003ccode\u003enext.js\u003c/code\u003e 框架切换到 \u003ccode\u003ecreate- react-app\u003c/code\u003e 的客户端渲染模式。这个需求还是很奇葩的，网上搜了一圈也没这个先例，于是就写了此文记录一下迁移以及都 \u003ccode\u003eCRA\u003c/code\u003e 的一些配置。\u003c/p\u003e\n\u003ch2\u003e迁移目标\u003c/h2\u003e\n\u003cp\u003e原有的项目基于 next.js 使用了 next.js 的路由以及一些 \u003ca href=\"https://www.nextjs.cn/docs/basic-features/data-fetching#getstaticprops-static-generation\"\u003e\u003ccode\u003egetStaticProps\u003c/code\u003e (Static Generation)\u003c/a\u003e 方法，要对其进行重写，首先是安装 CRA 脚手架，将页面迁移过去，然后再配置 \u003ccode\u003ereact-router-dom\u003c/code\u003e, \u003ccode\u003ereact-redux-toolkit\u003c/code\u003e 等，最后在配置一下 \u003ccode\u003etypescript\u003c/code\u003e 的开发环境。\u003c/p\u003e\n\u003ch2\u003e安装脚手架 create- react-app\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e# 在项目的根目录\nnpx create-react-app my-app --typescript\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样就在根目录新建了一个项目，这里可以先把子项目 \u003ccode\u003e/my-app/node_modules\u003c/code\u003e 添加到 \u003ccode\u003e.gitignore\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e后面安装依赖：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003e{\n  \"@reduxjs/toolkit\": \"^1.6.1\",\n  \"react-redux\": \"^7.2.4\",\n\t\"react-router-dom\": \"^5.2.1\",\n  \"redux\": \"^4.1.1\",\n  \"@types/react-redux\": \"^7.1.18\",\n\t\"@types/react-router-dom\": \"^5.1.8\",\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ereact-router-dom\u003c/h3\u003e\n\u003cp\u003e由于之前的 \u003ccode\u003enext.js\u003c/code\u003e 是约定式路由，改成使用  \u003ccode\u003ereact-router-dom\u003c/code\u003e,  加之公司其他的项目都是使用的配置式的路由，所以需要对其进行改造，经过研究，在项目的 \u003ccode\u003eindex.tsx\u003c/code\u003e引入路由，在 \u003ccode\u003eApp.tsx\u003c/code\u003e中配置路由表。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003enpm i -S react-router-dom\nnpm i -D @types/react-router-dom\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { HashRouter as Router } from 'react-router-dom';\nReactDOM.render(\n\t\t\u0026#x3C;React.StrictMode\u003e\n\t\t\t\u0026#x3C;Router\u003e\n\t\t\t\t\u0026#x3C;App /\u003e\n\t\t\t\u0026#x3C;/Router\u003e\n\t\t\u0026#x3C;/React.StrictMode\u003e\n  ,\n\tdocument.getElementById('root')\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { Route, Switch } from 'react-router-dom';\nexport default function App() {\n  return (\n\t\t\u0026#x3C;div className=\"App\"\u003e\n\t\t\t\u0026#x3C;Switch\u003e\n\t\t\t\t\u0026#x3C;Route path=\"/login\" component={Login} /\u003e\n\t\t\t\t\u0026#x3C;Route path=\"/oauth\" component={Oauth} /\u003e\n\t\t\t\t\u0026#x3C;Route path=\"/dashboard\" component={Dashboard} /\u003e\n\t\t\t\u0026#x3C;/Switch\u003e\n\t\t\u0026#x3C;/div\u003e\n\t);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e这里的路由是直接写在里面，也可以配置一个 路由表 然后渲染成组件，这样更加解耦\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003econst configRoute = [\n  {\n    path:'/login', component: Oauth,\n    ...\n  }\n];\nreturn (\n    \u0026#x3C;Switch\u003e\n    \t{configRoute.map(route)=\u003e(\n      \t\u0026#x3C;Route path={route.path}, component={route.component}\u003e\u0026#x3C;/Route\u003e\n      )}\n    \u0026#x3C;/Switch\u003e\n    );\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e对于 \u003ccode\u003enext/router\u003c/code\u003e 还有一个 \u003ccode\u003euseRouter\u003c/code\u003e， 可以使用 \u003ccode\u003euseHistory\u003c/code\u003e , \u003ccode\u003euseLocation\u003c/code\u003e来代替：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { useHistory, useLocation } from 'react-router-dom';\nfunction App() {\n\tconst history = useHistory();\n  // 获取搜索栏的地址\n\tconst { search } = useLocation();\n\tuseEffect(() =\u003e {\n\t\tif (search) {\n\t\t\thistory.push(`/oauth${search}`);\n\t\t} else {\n\t\t\thistory.push('/dashboard');\n\t\t}\n\t}, [history, search]);\n\treturn (\n\t\t...\n\t);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样一来 \u003ccode\u003enext/router\u003c/code\u003e  的功能就被代替了，下面配置 \u003ccode\u003ereact-redux\u003c/code\u003e 进行状态管理。\u003c/p\u003e\n\u003ch3\u003ereact-redux\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003enpm i -S @reduxjs/toolkit react-redux redux\nnpm i -D @types/react-redux\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e首先是 \u003ccode\u003eindex.tsx\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { Provider } from 'react-redux';\nimport store from './store/store';\n\nReactDOM.render(\n\t\u0026#x3C;Provider store={store}\u003e\n\t\t\u0026#x3C;App /\u003e\n\t\u0026#x3C;/Provider\u003e,\n\tdocument.getElementById('root')\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e配置的 store ：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-ts\"\u003e// store.ts\nimport { configureStore, ThunkAction, Action } from '@reduxjs/toolkit'\n// 按照模块划分需要保存的状态\nimport userReducer from './modules/userSlice'\nexport function makeStore() {\n  return configureStore({\n    reducer: { user: userReducer },\n  })\n}\n\nconst store = makeStore()\n// 导出类型\nexport type AppState = ReturnType\u0026#x3C;typeof store.getState\u003e\nexport type AppDispatch = typeof store.dispatch\nexport type AppThunk\u0026#x3C;ReturnType = void\u003e = ThunkAction\u0026#x3C;\n  ReturnType,\n  AppState,\n  unknown,\n  Action\u0026#x3C;string\u003e\n\u003e\nexport default store\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003euser 模块：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { createSlice, PayloadAction } from '@reduxjs/toolkit';\nimport type { AppState } from '@/store/store';\n\nexport interface UserState {\n\tuserName: string;\n}\n// 创建一个初始的状态\nconst initialState: UserState = {\n\tuserName: '',\n};\n\nexport const userSlice = createSlice({\n\tname: 'user',\n\tinitialState,\n\treducers: {\n    // 类似于 vuex mutations\n\t\tgetUserInfo: (state, { payload }: PayloadAction\u0026#x3C;UserState\u003e) =\u003e {\n\t\t\treturn payload;\n\t\t},\n\t},\n});\n\nexport const { getUserInfo } = userSlice.actions;\n\nexport const selectUserName = (state: AppState) =\u003e state.user.userName;\n\nexport default userSlice.reducer;\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e另外 \u003ccode\u003ereact-redux\u003c/code\u003e 还提供了几个hook 用于使用：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux';\n\nimport type { AppDispatch, AppState } from './store';\n\n// Use throughout your app instead of plain `useDispatch` and `useSelector`\nexport const useAppDispatch = () =\u003e useDispatch\u0026#x3C;AppDispatch\u003e();\n\nexport const useAppSelector: TypedUseSelectorHook\u0026#x3C;AppState\u003e = useSelector;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用方法可以看这个例子：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-tsx\"\u003eimport { useAppDispatch } from '@/store/hooks';\nimport { getUserInfo } from '@/store/modules/userSlice';\nconst App = ()=\u003e{\n  const dispatch = useAppDispatch();\n  const handleClick = (data)=\u003e{\n    dispatch(getUserInfo({ userInfo: data }));\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e对于 异步 actions 回头再研究研究\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3\u003eeject? customize-cra?\u003c/h3\u003e\n\u003cp\u003e上面的配置完成之后，对于之前使用的一些 alias， proxy 等还需要继续配置，这里有两种情况\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e运行 \u003ccode\u003enpm run eject\u003c/code\u003e 弹出隐藏的 \u003ccode\u003ewebpack\u003c/code\u003e 配置，在其中配置参数；\u003c/li\u003e\n\u003cli\u003e使用 \u003ccode\u003ecustomize-cra\u003c/code\u003e + \u003ccode\u003ereact-app-rewired\u003c/code\u003e 进行个性化配置\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e本次迁移中一开始选择使用第二种方法，\u003ccode\u003ecustomize-cra\u003c/code\u003e + \u003ccode\u003ereact-app-rewired\u003c/code\u003e ，\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-js\"\u003econst { useBabelRc, override } = require('customize-cra');\nconst { alias, configPaths } = require('react-app-rewire-alias');\n\nconst aliasMap = configPaths('./tsconfig.path.json')\n\nconsole.log(__dirname);\nconst config = override(\n\t// eslint-disable-next-line\n\tuseBabelRc(),\n\talias(aliasMap)\n);\n\nmodule.exports = config;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e但是后面发现每次配置的时候都需要去查对应的封装的包，有点麻烦于是索性 \u003ccode\u003eeject\u003c/code\u003e ，自由配置 \u003ccode\u003ewebpack \u003c/code\u003e . \u003ccode\u003eeject\u003c/code\u003e 之后主要配置项就在 \u003ccode\u003e/config\u003c/code\u003e 目录下了，这里的配置大同小异，不会的小朋友可以去看看 《深入浅出webpack》.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eeject\u003c/code\u003e还带来了一个目录 \u003ccode\u003e/scripts\u003c/code\u003e 里面写了打包编译的脚本文件，一般不用动，有时间可以看下，在启动项目和打包的时候 \u003ccode\u003ecreate-react-app\u003c/code\u003e到底做了什么工作。\u003c/p\u003e\n\u003ch2\u003e去除 next.js 依赖\u003c/h2\u003e\n\u003cp\u003e脚手架安装完成之后就是对项目进行迁移，并把\u003ccode\u003enext.js\u003c/code\u003e相关的 类似于 \u003ccode\u003enext/link\u003c/code\u003e，\u003ccode\u003enext/router\u003c/code\u003e等依赖切换成对应的 \u003ccode\u003ereact-router-dom\u003c/code\u003e的方法和包。\u003c/p\u003e\n\u003ch2\u003e配置 create-react-app 成为 react 开发环境\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e在 \u003ccode\u003e.env\u003c/code\u003e 文件里 以 \u003ccode\u003eREACT_APP_\u003c/code\u003e 开头配置地址等文件\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e创建 \u003ccode\u003e/src/types/index.d.ts\u003c/code\u003e  声明一些静态文件的类型\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-typescript\"\u003e  declare module '*.svg';\n  declare module '*.png';\n  declare module '*.jpg';\n  declare module '*.jpeg';\n  declare module '*.gif';\n\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\n\u003cp\u003e设置别名和 \u003ccode\u003ebaseUrl\u003c/code\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e一个是在\u003ccode\u003ewebpack \u003c/code\u003e里面设置，用于打包的时候，不过这里\u003ccode\u003ecreate-react-app\u003c/code\u003e的配置已经处理了，会读取项目中的\u003ccode\u003et/jsconfig.json\u003c/code\u003e 文件里面的配置。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e还有一个是在 \u003ccode\u003etsconfig.json\u003c/code\u003e 设置，用于开发的时候在 ide 里面解析\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003e\"baseUrl\": \"./\",\n\"paths\": {\n\t\"@/*\": [\"./src/*\"]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003e后记\u003c/h2\u003e\n\u003cp\u003e这个文章告诉我们的道理是，技术选型首先要慎重，根据项目的场景选择最合适的技术栈；其次是要选择熟悉的技术，否则后面的维护会受到影响；还有就是一旦遇到问题，当发现技术确实与现有的业务不匹配的时候，抓紧时间进行切换，减少沉默成本。\u003c/p\u003e\n","coverImage":"/assets/blog/nextjs.jfif"}},"__N_SSG":true},"page":"/tech/[slug]","query":{"slug":"migrating-cra"},"buildId":"tDsM1wHyHGJqsCwdxqJTA","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>