<!DOCTYPE html><html lang="en"><head><link rel="stylesheet" href="/style/index.css"/><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&amp;display=swap"/><script async="" defer="" data-website-id="3890bdd6-8ff5-4da5-8b72-45ba24876897" src="https://umami-alfxjx.up.railway.app/umami.js"></script><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/2649b9740f492fab27ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2649b9740f492fab27ec.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8fa755d3830e88407993.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8fa755d3830e88407993.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-6c6eb080c4d41d8fd79b.js" defer=""></script><script src="/_next/static/chunks/main-4fc50673e5500481d568.js" defer=""></script><script src="/_next/static/chunks/pages/_app-075949e5fa5ffddc911e.js" defer=""></script><script src="/_next/static/chunks/252f366e-b63e9f131b12ce609c69.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-b8804bb07d4f86914404.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-eb29eaaad2b07bc95110.js" defer=""></script><script src="/_next/static/chunks/1a48c3c1-63272919e4bbaae4097e.js" defer=""></script><script src="/_next/static/chunks/608-bb5bf9a1b1d10ad22ac0.js" defer=""></script><script src="/_next/static/chunks/553-f50d93340fc41d40714e.js" defer=""></script><script src="/_next/static/chunks/307-d4f637d0181fb2085729.js" defer=""></script><script src="/_next/static/chunks/pages/tech/%5Bslug%5D-6a6947d46afa43b14f3e.js" defer=""></script><script src="/_next/static/Q5-ARss9H4OnstBP8NDja/_buildManifest.js" defer=""></script><script src="/_next/static/Q5-ARss9H4OnstBP8NDja/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap">@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrFJM.woff) format('woff')}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9V1g.woff) format('woff')}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJbecnFHGPezSQ.woff2) format('woff2');unicode-range:U+0900-097F,U+1CD0-1CF6,U+1CF8-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FB}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJnecnFHGPezSQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Poppins';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJfecnFHGPc.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z11lFd2JQEl8qw.woff2) format('woff2');unicode-range:U+0900-097F,U+1CD0-1CF6,U+1CF8-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FB}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1JlFd2JQEl8qw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Poppins';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFd2JQEk.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="Post__Wrapper-sc-q8sq7-0 dzXARM"><div class="ProgressBar__FixedTopWrapper-sc-1ufpd9c-0 ProgressBar__ProgressBarWrapperFixed-sc-1ufpd9c-1 lmAxqe ketkUq"><div class="bar-used"></div></div><div class="header"><div class="icon-wrapper"><div class="icons"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 11H6.414l5.293-5.293-1.414-1.414L2.586 12l7.707 7.707 1.414-1.414L6.414 13H21z"></path></svg></div><div class="icons"><a href="/tech"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m7.375 16.781 1.25-1.562L4.601 12l4.024-3.219-1.25-1.562-5 4a1 1 0 0 0 0 1.562l5 4zm9.25-9.562-1.25 1.562L19.399 12l-4.024 3.219 1.25 1.562 5-4a1 1 0 0 0 0-1.562l-5-4zm-1.649-4.003-4 18-1.953-.434 4-18z"></path></svg></a></div></div></div><div class="toggle"><button class="switch__SwitchWrapper-sc-19ps08m-0 eMIOez"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path></svg><div class="round"></div></button></div><div style="height:3.25rem"></div><div class="Post-sc-1u8x57o-0 Post__PostWrapper-sc-q8sq7-1 hcSpXI fqyuhB"><div class="info"><h1>Next.js 项目迁移到 create-react-app</h1><div class="user"><img class="img" src="/assets/authors/alfxjx.jpg" alt="Alfxjx"/><span class="title">Alfxjx</span><div class="date">2021-09-21</div></div></div><div class="post"><p>公司的统一登录项目之前部署在私有云上采用的是 <code>next.js</code>，虽然存在一些问题但是还能使用。现在统一部署到公司自建的 devops 平台，由于平台只有通用的 <code>react</code> 流水线，部署之后是客户端渲染的类型（<code>CSR</code>），导致之前的服务端渲染部署上去存在很多问题，调整成 <code>SSG</code> 模式部署上去也存在很多问题，例如 <code>redux</code> 状态管理问题以及 <code>router</code> 跳转问题，针对这些问题，最终决定从 <code>next.js</code> 框架切换到 <code>create- react-app</code> 的客户端渲染模式。这个需求还是很奇葩的，网上搜了一圈也没这个先例，于是就写了此文记录一下迁移以及都 <code>CRA</code> 的一些配置。</p>
<h2>迁移目标</h2>
<p>原有的项目基于 next.js 使用了 next.js 的路由以及一些 <a href="https://www.nextjs.cn/docs/basic-features/data-fetching#getstaticprops-static-generation"><code>getStaticProps</code> (Static Generation)</a> 方法，要对其进行重写，首先是安装 CRA 脚手架，将页面迁移过去，然后再配置 <code>react-router-dom</code>, <code>react-redux-toolkit</code> 等，最后在配置一下 <code>typescript</code> 的开发环境。</p>
<h2>安装脚手架 create- react-app</h2>
<pre><code># 在项目的根目录
npx create-react-app my-app --typescript
</code></pre>
<p>这样就在根目录新建了一个项目，这里可以先把子项目 <code>/my-app/node_modules</code> 添加到 <code>.gitignore</code>.</p>
<p>后面安装依赖：</p>
<pre><code>{
  "@reduxjs/toolkit": "^1.6.1",
  "react-redux": "^7.2.4",
	"react-router-dom": "^5.2.1",
  "redux": "^4.1.1",
  "@types/react-redux": "^7.1.18",
	"@types/react-router-dom": "^5.1.8",
}
</code></pre>
<h3>react-router-dom</h3>
<p>由于之前的 <code>next.js</code> 是约定式路由，改成使用  <code>react-router-dom</code>,  加之公司其他的项目都是使用的配置式的路由，所以需要对其进行改造，经过研究，在项目的 <code>index.tsx</code>引入路由，在 <code>App.tsx</code>中配置路由表。</p>
<pre><code>npm i -S react-router-dom
npm i -D @types/react-router-dom
</code></pre>
<pre><code>import { HashRouter as Router } from 'react-router-dom';
ReactDOM.render(
		&#x3C;React.StrictMode>
			&#x3C;Router>
				&#x3C;App />
			&#x3C;/Router>
		&#x3C;/React.StrictMode>
  ,
	document.getElementById('root')
);
</code></pre>
<pre><code>import { Route, Switch } from 'react-router-dom';
export default function App() {
  return (
		&#x3C;div className="App">
			&#x3C;Switch>
				&#x3C;Route path="/login" component={Login} />
				&#x3C;Route path="/oauth" component={Oauth} />
				&#x3C;Route path="/dashboard" component={Dashboard} />
			&#x3C;/Switch>
		&#x3C;/div>
	);
}
</code></pre>
<blockquote>
<p>这里的路由是直接写在里面，也可以配置一个 路由表 然后渲染成组件，这样更加解耦</p>
</blockquote>
<pre><code>const configRoute = [
  {
    path:'/login', component: Oauth,
    ...
  }
];
return (
    &#x3C;Switch>
    	{configRoute.map(route)=>(
      	&#x3C;Route path={route.path}, component={route.component}>&#x3C;/Route>
      )}
    &#x3C;/Switch>
    );
</code></pre>
<p>对于 <code>next/router</code> 还有一个 <code>useRouter</code>， 可以使用 <code>useHistory</code> , <code>useLocation</code>来代替：</p>
<pre><code>import { useHistory, useLocation } from 'react-router-dom';
function App() {
	const history = useHistory();
  // 获取搜索栏的地址
	const { search } = useLocation();
	useEffect(() => {
		if (search) {
			history.push(`/oauth${search}`);
		} else {
			history.push('/dashboard');
		}
	}, [history, search]);
	return (
		...
	);
}
</code></pre>
<p>这样一来 <code>next/router</code>  的功能就被代替了，下面配置 <code>react-redux</code> 进行状态管理。</p>
<h3>react-redux</h3>
<pre><code>npm i -S @reduxjs/toolkit react-redux redux
npm i -D @types/react-redux
</code></pre>
<p>首先是 <code>index.tsx</code></p>
<pre><code>import { Provider } from 'react-redux';
import store from './store/store';

ReactDOM.render(
	&#x3C;Provider store={store}>
		&#x3C;App />
	&#x3C;/Provider>,
	document.getElementById('root')
);
</code></pre>
<p>配置的 store ：</p>
<pre><code>// store.ts
import { configureStore, ThunkAction, Action } from '@reduxjs/toolkit'
// 按照模块划分需要保存的状态
import userReducer from './modules/userSlice'
export function makeStore() {
  return configureStore({
    reducer: { user: userReducer },
  })
}

const store = makeStore()
// 导出类型
export type AppState = ReturnType&#x3C;typeof store.getState>
export type AppDispatch = typeof store.dispatch
export type AppThunk&#x3C;ReturnType = void> = ThunkAction&#x3C;
  ReturnType,
  AppState,
  unknown,
  Action&#x3C;string>
>
export default store

</code></pre>
<p>user 模块：</p>
<pre><code>import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import type { AppState } from '@/store/store';

export interface UserState {
	userName: string;
}
// 创建一个初始的状态
const initialState: UserState = {
	userName: '',
};

export const userSlice = createSlice({
	name: 'user',
	initialState,
	reducers: {
    // 类似于 vuex mutations
		getUserInfo: (state, { payload }: PayloadAction&#x3C;UserState>) => {
			return payload;
		},
	},
});

export const { getUserInfo } = userSlice.actions;

export const selectUserName = (state: AppState) => state.user.userName;

export default userSlice.reducer;

</code></pre>
<p>另外 <code>react-redux</code> 还提供了几个hook 用于使用：</p>
<pre><code>import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux';

import type { AppDispatch, AppState } from './store';

// Use throughout your app instead of plain `useDispatch` and `useSelector`
export const useAppDispatch = () => useDispatch&#x3C;AppDispatch>();

export const useAppSelector: TypedUseSelectorHook&#x3C;AppState> = useSelector;
</code></pre>
<p>使用方法可以看这个例子：</p>
<pre><code>import { useAppDispatch } from '@/store/hooks';
import { getUserInfo } from '@/store/modules/userSlice';
const App = ()=>{
  const dispatch = useAppDispatch();
  const handleClick = (data)=>{
    dispatch(getUserInfo({ userInfo: data }));
  }
}
</code></pre>
<blockquote>
<p>对于 异步 actions 回头再研究研究</p>
</blockquote>
<h3>eject? customize-cra?</h3>
<p>上面的配置完成之后，对于之前使用的一些 alias， proxy 等还需要继续配置，这里有两种情况</p>
<ol>
<li>运行 <code>npm run eject</code> 弹出隐藏的 <code>webpack</code> 配置，在其中配置参数；</li>
<li>使用 <code>customize-cra</code> + <code>react-app-rewired</code> 进行个性化配置</li>
</ol>
<p>本次迁移中一开始选择使用第二种方法，<code>customize-cra</code> + <code>react-app-rewired</code> ，</p>
<pre><code>const { useBabelRc, override } = require('customize-cra');
const { alias, configPaths } = require('react-app-rewire-alias');

const aliasMap = configPaths('./tsconfig.path.json')

console.log(__dirname);
const config = override(
	// eslint-disable-next-line
	useBabelRc(),
	alias(aliasMap)
);

module.exports = config;
</code></pre>
<p>但是后面发现每次配置的时候都需要去查对应的封装的包，有点麻烦于是索性 <code>eject</code> ，自由配置 <code>webpack </code> . <code>eject</code> 之后主要配置项就在 <code>/config</code> 目录下了，这里的配置大同小异，不会的小朋友可以去看看 《深入浅出webpack》.</p>
<p><code>eject</code>还带来了一个目录 <code>/scripts</code> 里面写了打包编译的脚本文件，一般不用动，有时间可以看下，在启动项目和打包的时候 <code>create-react-app</code>到底做了什么工作。</p>
<h2>去除 next.js 依赖</h2>
<p>脚手架安装完成之后就是对项目进行迁移，并把<code>next.js</code>相关的 类似于 <code>next/link</code>，<code>next/router</code>等依赖切换成对应的 <code>react-router-dom</code>的方法和包。</p>
<h2>配置 create-react-app 成为 react 开发环境</h2>
<ol>
<li>
<p>在 <code>.env</code> 文件里 以 <code>REACT_APP_</code> 开头配置地址等文件</p>
</li>
<li>
<p>创建 <code>/src/types/index.d.ts</code>  声明一些静态文件的类型</p>
</li>
</ol>
<pre><code>  declare module '*.svg';
  declare module '*.png';
  declare module '*.jpg';
  declare module '*.jpeg';
  declare module '*.gif';
</code></pre>
<ol start="3">
<li>
<p>设置别名和 <code>baseUrl</code></p>
<ul>
<li>
<p>一个是在<code>webpack </code>里面设置，用于打包的时候，不过这里<code>create-react-app</code>的配置已经处理了，会读取项目中的<code>t/jsconfig.json</code> 文件里面的配置。</p>
</li>
<li>
<p>还有一个是在 <code>tsconfig.json</code> 设置，用于开发的时候在 ide 里面解析</p>
</li>
</ul>
<pre><code>"baseUrl": "./",
"paths": {
	"@/*": ["./src/*"]
}
</code></pre>
</li>
</ol>
<h2>后记</h2>
<p>这个文章告诉我们的道理是，技术选型首先要慎重，根据项目的场景选择最合适的技术栈；其次是要选择熟悉的技术，否则后面的维护会受到影响；还有就是一旦遇到问题，当发现技术确实与现有的业务不匹配的时候，抓紧时间进行切换，减少沉默成本。</p>
</div><div id="comments"></div></div><div class="Footer__FooterWrapper-sc-1ysspqt-0 bPlNKY"><div class="my-main-font text"><span>Powerd by <a href="https://nextjs.org">Next.js</a> on<!-- --> <a href="https://vercel.com">Vercel</a> with ♥ 2020-<!-- -->2022</span></div><div class="Footer__IconList-sc-1ysspqt-1 fShAcK"><a href="https://github.com/alfxjx"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://twitter.com/alfxjx"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://weibo.com/u/1950371745"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"></path></svg></a><a href="https://juejin.cn/user/2330620383728551"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.445 21.832a1 1 0 0 0 1.11 0l9-6A.998.998 0 0 0 21.8 14.4l-9-12c-.377-.504-1.223-.504-1.6 0l-9 12a1 1 0 0 0 .245 1.432l9 6zM13 19.131V6l6.565 8.754L13 19.131zM11 6v13.131l-6.565-4.377L11 6z"></path></svg></a><a href="https://umami-alfxjx.up.railway.app/share/eaSooCGG/Blog"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M181.9 256.1c-5-16-4.9-46.9-2-46.9 8.4 0 7.6 36.9 2 46.9zm-1.7 47.2c-7.7 20.2-17.3 43.3-28.4 62.7 18.3-7 39-17.2 62.9-21.9-12.7-9.6-24.9-23.4-34.5-40.8zM86.1 428.1c0 .8 13.2-5.4 34.9-40.2-6.7 6.3-29.1 24.5-34.9 40.2zM248 160h136v328c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V24C0 10.7 10.7 0 24 0h200v136c0 13.2 10.8 24 24 24zm-8 171.8c-20-12.2-33.3-29-42.7-53.8 4.5-18.5 11.6-46.6 6.2-64.2-4.7-29.4-42.4-26.5-47.8-6.8-5 18.3-.4 44.1 8.1 77-11.6 27.6-28.7 64.6-40.8 85.8-.1 0-.1.1-.2.1-27.1 13.9-73.6 44.5-54.5 68 5.6 6.9 16 10 21.5 10 17.9 0 35.7-18 61.1-61.8 25.8-8.5 54.1-19.1 79-23.2 21.7 11.8 47.1 19.5 64 19.5 29.2 0 31.2-32 19.7-43.4-13.9-13.6-54.3-9.7-73.6-7.2zM377 105L279 7c-4.5-4.5-10.6-7-17-7h-6v128h128v-6.1c0-6.3-2.5-12.4-7-16.9zm-74.1 255.3c4.1-2.7-2.5-11.9-42.8-9 37.1 15.8 42.8 9 42.8 9z"></path></svg></a><a href="/xujianxiang-resume.pdf"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" width="1em" height="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-5h2v5zm4 0h-2v-3h2v3zm0-5h-2v-2h2v2zm4 5h-2V7h2v10z"></path></svg></a></div></div></div><div class="Toast__StyledContainer-sc-1p228qg-0 gWqgDn"><div class="Toastify"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Next.js 项目迁移到 create-react-app","date":"2021-09-20T17:10:00.000Z","slug":"migrating-cra","author":{"name":"Alfxjx","picture":"/assets/authors/alfxjx.jpg"},"content":"\u003cp\u003e公司的统一登录项目之前部署在私有云上采用的是 \u003ccode\u003enext.js\u003c/code\u003e，虽然存在一些问题但是还能使用。现在统一部署到公司自建的 devops 平台，由于平台只有通用的 \u003ccode\u003ereact\u003c/code\u003e 流水线，部署之后是客户端渲染的类型（\u003ccode\u003eCSR\u003c/code\u003e），导致之前的服务端渲染部署上去存在很多问题，调整成 \u003ccode\u003eSSG\u003c/code\u003e 模式部署上去也存在很多问题，例如 \u003ccode\u003eredux\u003c/code\u003e 状态管理问题以及 \u003ccode\u003erouter\u003c/code\u003e 跳转问题，针对这些问题，最终决定从 \u003ccode\u003enext.js\u003c/code\u003e 框架切换到 \u003ccode\u003ecreate- react-app\u003c/code\u003e 的客户端渲染模式。这个需求还是很奇葩的，网上搜了一圈也没这个先例，于是就写了此文记录一下迁移以及都 \u003ccode\u003eCRA\u003c/code\u003e 的一些配置。\u003c/p\u003e\n\u003ch2\u003e迁移目标\u003c/h2\u003e\n\u003cp\u003e原有的项目基于 next.js 使用了 next.js 的路由以及一些 \u003ca href=\"https://www.nextjs.cn/docs/basic-features/data-fetching#getstaticprops-static-generation\"\u003e\u003ccode\u003egetStaticProps\u003c/code\u003e (Static Generation)\u003c/a\u003e 方法，要对其进行重写，首先是安装 CRA 脚手架，将页面迁移过去，然后再配置 \u003ccode\u003ereact-router-dom\u003c/code\u003e, \u003ccode\u003ereact-redux-toolkit\u003c/code\u003e 等，最后在配置一下 \u003ccode\u003etypescript\u003c/code\u003e 的开发环境。\u003c/p\u003e\n\u003ch2\u003e安装脚手架 create- react-app\u003c/h2\u003e\n\u003cpre\u003e\u003ccode\u003e# 在项目的根目录\r\nnpx create-react-app my-app --typescript\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样就在根目录新建了一个项目，这里可以先把子项目 \u003ccode\u003e/my-app/node_modules\u003c/code\u003e 添加到 \u003ccode\u003e.gitignore\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e后面安装依赖：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e{\r\n  \"@reduxjs/toolkit\": \"^1.6.1\",\r\n  \"react-redux\": \"^7.2.4\",\r\n\t\"react-router-dom\": \"^5.2.1\",\r\n  \"redux\": \"^4.1.1\",\r\n  \"@types/react-redux\": \"^7.1.18\",\r\n\t\"@types/react-router-dom\": \"^5.1.8\",\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ereact-router-dom\u003c/h3\u003e\n\u003cp\u003e由于之前的 \u003ccode\u003enext.js\u003c/code\u003e 是约定式路由，改成使用  \u003ccode\u003ereact-router-dom\u003c/code\u003e,  加之公司其他的项目都是使用的配置式的路由，所以需要对其进行改造，经过研究，在项目的 \u003ccode\u003eindex.tsx\u003c/code\u003e引入路由，在 \u003ccode\u003eApp.tsx\u003c/code\u003e中配置路由表。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003enpm i -S react-router-dom\r\nnpm i -D @types/react-router-dom\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eimport { HashRouter as Router } from 'react-router-dom';\r\nReactDOM.render(\r\n\t\t\u0026#x3C;React.StrictMode\u003e\r\n\t\t\t\u0026#x3C;Router\u003e\r\n\t\t\t\t\u0026#x3C;App /\u003e\r\n\t\t\t\u0026#x3C;/Router\u003e\r\n\t\t\u0026#x3C;/React.StrictMode\u003e\r\n  ,\r\n\tdocument.getElementById('root')\r\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eimport { Route, Switch } from 'react-router-dom';\r\nexport default function App() {\r\n  return (\r\n\t\t\u0026#x3C;div className=\"App\"\u003e\r\n\t\t\t\u0026#x3C;Switch\u003e\r\n\t\t\t\t\u0026#x3C;Route path=\"/login\" component={Login} /\u003e\r\n\t\t\t\t\u0026#x3C;Route path=\"/oauth\" component={Oauth} /\u003e\r\n\t\t\t\t\u0026#x3C;Route path=\"/dashboard\" component={Dashboard} /\u003e\r\n\t\t\t\u0026#x3C;/Switch\u003e\r\n\t\t\u0026#x3C;/div\u003e\r\n\t);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e这里的路由是直接写在里面，也可以配置一个 路由表 然后渲染成组件，这样更加解耦\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode\u003econst configRoute = [\r\n  {\r\n    path:'/login', component: Oauth,\r\n    ...\r\n  }\r\n];\r\nreturn (\r\n    \u0026#x3C;Switch\u003e\r\n    \t{configRoute.map(route)=\u003e(\r\n      \t\u0026#x3C;Route path={route.path}, component={route.component}\u003e\u0026#x3C;/Route\u003e\r\n      )}\r\n    \u0026#x3C;/Switch\u003e\r\n    );\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e对于 \u003ccode\u003enext/router\u003c/code\u003e 还有一个 \u003ccode\u003euseRouter\u003c/code\u003e， 可以使用 \u003ccode\u003euseHistory\u003c/code\u003e , \u003ccode\u003euseLocation\u003c/code\u003e来代替：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { useHistory, useLocation } from 'react-router-dom';\r\nfunction App() {\r\n\tconst history = useHistory();\r\n  // 获取搜索栏的地址\r\n\tconst { search } = useLocation();\r\n\tuseEffect(() =\u003e {\r\n\t\tif (search) {\r\n\t\t\thistory.push(`/oauth${search}`);\r\n\t\t} else {\r\n\t\t\thistory.push('/dashboard');\r\n\t\t}\r\n\t}, [history, search]);\r\n\treturn (\r\n\t\t...\r\n\t);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样一来 \u003ccode\u003enext/router\u003c/code\u003e  的功能就被代替了，下面配置 \u003ccode\u003ereact-redux\u003c/code\u003e 进行状态管理。\u003c/p\u003e\n\u003ch3\u003ereact-redux\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003enpm i -S @reduxjs/toolkit react-redux redux\r\nnpm i -D @types/react-redux\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e首先是 \u003ccode\u003eindex.tsx\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { Provider } from 'react-redux';\r\nimport store from './store/store';\r\n\r\nReactDOM.render(\r\n\t\u0026#x3C;Provider store={store}\u003e\r\n\t\t\u0026#x3C;App /\u003e\r\n\t\u0026#x3C;/Provider\u003e,\r\n\tdocument.getElementById('root')\r\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e配置的 store ：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// store.ts\r\nimport { configureStore, ThunkAction, Action } from '@reduxjs/toolkit'\r\n// 按照模块划分需要保存的状态\r\nimport userReducer from './modules/userSlice'\r\nexport function makeStore() {\r\n  return configureStore({\r\n    reducer: { user: userReducer },\r\n  })\r\n}\r\n\r\nconst store = makeStore()\r\n// 导出类型\r\nexport type AppState = ReturnType\u0026#x3C;typeof store.getState\u003e\r\nexport type AppDispatch = typeof store.dispatch\r\nexport type AppThunk\u0026#x3C;ReturnType = void\u003e = ThunkAction\u0026#x3C;\r\n  ReturnType,\r\n  AppState,\r\n  unknown,\r\n  Action\u0026#x3C;string\u003e\r\n\u003e\r\nexport default store\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003euser 模块：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { createSlice, PayloadAction } from '@reduxjs/toolkit';\r\nimport type { AppState } from '@/store/store';\r\n\r\nexport interface UserState {\r\n\tuserName: string;\r\n}\r\n// 创建一个初始的状态\r\nconst initialState: UserState = {\r\n\tuserName: '',\r\n};\r\n\r\nexport const userSlice = createSlice({\r\n\tname: 'user',\r\n\tinitialState,\r\n\treducers: {\r\n    // 类似于 vuex mutations\r\n\t\tgetUserInfo: (state, { payload }: PayloadAction\u0026#x3C;UserState\u003e) =\u003e {\r\n\t\t\treturn payload;\r\n\t\t},\r\n\t},\r\n});\r\n\r\nexport const { getUserInfo } = userSlice.actions;\r\n\r\nexport const selectUserName = (state: AppState) =\u003e state.user.userName;\r\n\r\nexport default userSlice.reducer;\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e另外 \u003ccode\u003ereact-redux\u003c/code\u003e 还提供了几个hook 用于使用：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux';\r\n\r\nimport type { AppDispatch, AppState } from './store';\r\n\r\n// Use throughout your app instead of plain `useDispatch` and `useSelector`\r\nexport const useAppDispatch = () =\u003e useDispatch\u0026#x3C;AppDispatch\u003e();\r\n\r\nexport const useAppSelector: TypedUseSelectorHook\u0026#x3C;AppState\u003e = useSelector;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用方法可以看这个例子：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { useAppDispatch } from '@/store/hooks';\r\nimport { getUserInfo } from '@/store/modules/userSlice';\r\nconst App = ()=\u003e{\r\n  const dispatch = useAppDispatch();\r\n  const handleClick = (data)=\u003e{\r\n    dispatch(getUserInfo({ userInfo: data }));\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e对于 异步 actions 回头再研究研究\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3\u003eeject? customize-cra?\u003c/h3\u003e\n\u003cp\u003e上面的配置完成之后，对于之前使用的一些 alias， proxy 等还需要继续配置，这里有两种情况\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e运行 \u003ccode\u003enpm run eject\u003c/code\u003e 弹出隐藏的 \u003ccode\u003ewebpack\u003c/code\u003e 配置，在其中配置参数；\u003c/li\u003e\n\u003cli\u003e使用 \u003ccode\u003ecustomize-cra\u003c/code\u003e + \u003ccode\u003ereact-app-rewired\u003c/code\u003e 进行个性化配置\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e本次迁移中一开始选择使用第二种方法，\u003ccode\u003ecustomize-cra\u003c/code\u003e + \u003ccode\u003ereact-app-rewired\u003c/code\u003e ，\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst { useBabelRc, override } = require('customize-cra');\r\nconst { alias, configPaths } = require('react-app-rewire-alias');\r\n\r\nconst aliasMap = configPaths('./tsconfig.path.json')\r\n\r\nconsole.log(__dirname);\r\nconst config = override(\r\n\t// eslint-disable-next-line\r\n\tuseBabelRc(),\r\n\talias(aliasMap)\r\n);\r\n\r\nmodule.exports = config;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e但是后面发现每次配置的时候都需要去查对应的封装的包，有点麻烦于是索性 \u003ccode\u003eeject\u003c/code\u003e ，自由配置 \u003ccode\u003ewebpack \u003c/code\u003e . \u003ccode\u003eeject\u003c/code\u003e 之后主要配置项就在 \u003ccode\u003e/config\u003c/code\u003e 目录下了，这里的配置大同小异，不会的小朋友可以去看看 《深入浅出webpack》.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eeject\u003c/code\u003e还带来了一个目录 \u003ccode\u003e/scripts\u003c/code\u003e 里面写了打包编译的脚本文件，一般不用动，有时间可以看下，在启动项目和打包的时候 \u003ccode\u003ecreate-react-app\u003c/code\u003e到底做了什么工作。\u003c/p\u003e\n\u003ch2\u003e去除 next.js 依赖\u003c/h2\u003e\n\u003cp\u003e脚手架安装完成之后就是对项目进行迁移，并把\u003ccode\u003enext.js\u003c/code\u003e相关的 类似于 \u003ccode\u003enext/link\u003c/code\u003e，\u003ccode\u003enext/router\u003c/code\u003e等依赖切换成对应的 \u003ccode\u003ereact-router-dom\u003c/code\u003e的方法和包。\u003c/p\u003e\n\u003ch2\u003e配置 create-react-app 成为 react 开发环境\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e在 \u003ccode\u003e.env\u003c/code\u003e 文件里 以 \u003ccode\u003eREACT_APP_\u003c/code\u003e 开头配置地址等文件\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e创建 \u003ccode\u003e/src/types/index.d.ts\u003c/code\u003e  声明一些静态文件的类型\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode\u003e  declare module '*.svg';\r\n  declare module '*.png';\r\n  declare module '*.jpg';\r\n  declare module '*.jpeg';\r\n  declare module '*.gif';\n\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\n\u003cp\u003e设置别名和 \u003ccode\u003ebaseUrl\u003c/code\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e一个是在\u003ccode\u003ewebpack \u003c/code\u003e里面设置，用于打包的时候，不过这里\u003ccode\u003ecreate-react-app\u003c/code\u003e的配置已经处理了，会读取项目中的\u003ccode\u003et/jsconfig.json\u003c/code\u003e 文件里面的配置。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e还有一个是在 \u003ccode\u003etsconfig.json\u003c/code\u003e 设置，用于开发的时候在 ide 里面解析\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode\u003e\"baseUrl\": \"./\",\r\n\"paths\": {\r\n\t\"@/*\": [\"./src/*\"]\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003e后记\u003c/h2\u003e\n\u003cp\u003e这个文章告诉我们的道理是，技术选型首先要慎重，根据项目的场景选择最合适的技术栈；其次是要选择熟悉的技术，否则后面的维护会受到影响；还有就是一旦遇到问题，当发现技术确实与现有的业务不匹配的时候，抓紧时间进行切换，减少沉默成本。\u003c/p\u003e\n","coverImage":"/assets/blog/nextjs.jfif"}},"__N_SSG":true},"page":"/tech/[slug]","query":{"slug":"migrating-cra"},"buildId":"Q5-ARss9H4OnstBP8NDja","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>