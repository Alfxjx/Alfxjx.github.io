<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/6ac04af9c34471e28ed7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6ac04af9c34471e28ed7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8fa755d3830e88407993.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8fa755d3830e88407993.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d4ca226b082815b6b5f.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/main-f388e32f9dd9c15fe4aa.js" defer=""></script><script src="/_next/static/chunks/pages/_app-195005c5a9d38cc7d564.js" defer=""></script><script src="/_next/static/chunks/852-2043476d938a0a39d6e5.js" defer=""></script><script src="/_next/static/chunks/235-a432b6402ce4c06862a7.js" defer=""></script><script src="/_next/static/chunks/pages/tech/%5Bslug%5D-c9f878197dc241e7f4d6.js" defer=""></script><script src="/_next/static/Yuf4f2ACmA9noj0-JpLSF/_buildManifest.js" defer=""></script><script src="/_next/static/Yuf4f2ACmA9noj0-JpLSF/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="Post__Wrapper-sc-q8sq7-0 blKUxx"><div class="ProgressBar__FixedTopWrapper-sc-1ufpd9c-0 ProgressBar__ProgressBarWrapperFixed-sc-1ufpd9c-1 jWNGKa bToMDz"><div class="bar-used"></div></div><div class="header"><div class="icon-wrapper"><div class="icons"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M872 474H286.9l350.2-304c5.6-4.9 2.2-14-5.2-14h-88.5c-3.9 0-7.6 1.4-10.5 3.9L155 487.8c-14.7 12.8-14.7 35.6 0 48.3L535.1 866c1.5 1.3 3.3 2 5.2 2h91.5c7.4 0 10.8-9.2 5.2-14L286.9 550H872c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"></path></svg></div><div class="icons"><a href="/tech"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M541.141 268.864l61.718 16.939-132.395 482.474-61.717-16.938L541.14 268.864zm-212.138 29.803l44.885 45.61-175.36 172.587 175.04 167.573-44.267 46.23-222.634-213.163 222.336-218.837zm355.882 0l222.336 218.837-222.634 213.163-44.267-46.23 175.019-167.573L640 344.277l44.885-45.61z"></path></svg></a></div></div></div><div class="toggle"><button class="Button__InsideButton-sc-19071w6-0 cyRVLS"><div class="LightDarkSwitcher__Switcher-sc-hbms9j-0 cBdTSF"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M448 64v195.2a224.832 224.832 0 0 0-100.992 42.24L208.512 163.2l-45.248 45.312 138.24 138.496A218.624 218.624 0 0 0 259.008 448H64v64h195.008c5.504 37.76 20.48 72 42.496 100.992l-138.24 138.496 45.248 45.248L347.008 658.24C376 680 410.496 695.232 448 700.736V896h64V700.8a222.4 222.4 0 0 0 100.992-42.56l138.496 138.496 45.248-45.248L658.24 612.992A216.32 216.32 0 0 0 700.992 512H896v-64H700.992a216.32 216.32 0 0 0-42.752-100.992l138.496-138.496-45.248-45.248-138.496 138.24A224.832 224.832 0 0 0 512 259.2V64zm32 256c88.768 0 160 71.232 160 160s-71.232 160-160 160a159.488 159.488 0 0 1-160-160c0-88.768 71.232-160 160-160z"></path></svg></div></button></div><div style="height:3.25rem"></div><div class="Post-sc-1u8x57o-0 Post__PostWrapper-sc-q8sq7-1 fbyABu mIDzq"><div class="info"><h1>[Vue]前端项目重构小记</h1><div class="user"><img class="img" src="/assets/authors/alfxjx.jpg" alt="Alfxjx"/><span class="title">Alfxjx</span><div class="date">2021-04-14</div></div></div><div class="post"><h2>重构目标</h2>
<p>原有的旧项目原本时前后端不分离的，在开发过程中对前端开发人员需要全项目启动，比较麻烦，同时项目在进行前后端分离之后，前端部分开发使用的时http-server启动服务，不支持<a href="https://www.webpackjs.com/concepts/hot-module-replacement/">HMR</a>，修改完成之后需要手动刷新。另外，原本的项目采用的基于jQuery的传统技术栈，在之后项目的迭代升级中，制约了项目的开发。因此开始了本次的前端项目重构。</p>
<p>重构的目标是将原本组合在一起的官网项目和客户自服务项目按照其功能分成两块。</p>
<p>通过此次重构为之后重构运营管理平台积累经验。</p>
<h2>项目结构</h2>
<h3>数据层</h3>
<h4>axios封装</h4>
<p>数据层原先存在的问题是，ajax请求分布在项目中，例如每进入一个页面都会请求的数据（logUser），事实上是在所有的页面中都重写了一次的逻辑，分散的逻辑不利于后期的维护，以及换人开发的时候上手会比较困难。</p>
<p><img src="/assets/blog/vue-jquery-0.png" alt="平均一个文件两个请求"></p>
<p>重构的项目中改善了此问题，方法就是统一管理请求，包括请求的处理以及请求方法的位置。基于webpack打包环境，引入axios，并对axios做一定的封装，实现：</p>
<ol>
<li>在发送请求之前和接收数据的时候统一处理</li>
<li>优化体验加上loading的过度效果，</li>
<li>对于某些需要用户登录权限的接口在拦截器中获取登录的权限并保持住登录状态。</li>
<li>根据环境变量控制请求的接口地址。</li>
</ol>
<p>这些改进需要配合后端的重构逐步实施，因为现在后台的请求不是完全统一，在后面的重构过程中需要将后台的返回统一化，这样也方便对数据的处理。目前针对此情况，对现有的接口做了一定的分类，按照请求的类型使用不同的axios实例具体可以参考<a href="">代码</a>, <strong>在拦截器中使用MessageBox的单例模式（伪）参考</strong><a href="https://www.yuque.com/alfxjx/gihbyq/odw8bw#rwKl0">我的笔记本的这个链接</a></p>
<pre><code class="language-javascript">const baseUrl = NODE_ENV === "development" ? "/api" : `${VUE_APP_PROD_API}`;

const axiosInstance = axios.create({
  baseURL: baseUrl
  // timeout: 30000,
});
// 请求拦截器，在发送之前对数据操作
axiosInstance.interceptors.request.use(function(config) {
  loadingInstance = Loading.service({
    fullscreen: true,
    lock: true,
    background: "transparent"
  });
  config.headers.authorization = sessionStorage.getItem("token");
  return config;
});
// 响应拦截
axiosInstance.interceptors.response.use(
  res => {
    clearTimeout(clearLoading);
    // 判断失误请求 httpCode=200
    if (res.data.code !== 0) {
      // ...
      loadingInstance.close();
      return;
    }
    // 拦截返回值里面的新的token，用于刷新保持登录态。
    // 大小写敏感
    const newToken = res.headers.authorization;
    // console.log(newToken);
    if (newToken) {
      sessionStorage.setItem("token", newToken);
    }
    loadingInstance.close();
    return res.data;
  },
  err => {
    // ...
    loadingInstance.close();
  }
);
</code></pre>
<p>重构的项目中使用 axios 对 http 请求进行了封装，默认是json格式的参数对象格式，对于某些未使用json格式对象的，暴露出一个基本axios请求对象实例，另外对于原始项目中较多的 form 请求格式，暴露一个form格式post请求函数。注意此函数需要对参数进行QS.stringfy()。</p>
<pre><code class="language-javascript">// 对于某些使用form格式接口的适配
function axiosFormRequest(url, data) {
  return axiosBase.post(url, Qs.stringify(data), {
    headers: {
      "Content-Type": "application/x-www-form-urlencoded; charset=utf-8;"
    }
  });
}
</code></pre>
<h4>请求根据环境变量配置不同的链接</h4>
<p>由于开发过程中，在本地启动，所以http请求会跨域，因此需要webpack的devServer对请求做一次转发，解决跨域问题：</p>
<pre><code class="language-javascript">// axios config.js
// dev环境下统一添加一个前缀/api,用以区分http请求和其他请求。
const { NODE_ENV, VUE_APP_PROD_API } = process.env;
const baseUrl = NODE_ENV === "development" ? "/api" : `${VUE_APP_PROD_API}`;
</code></pre>
<p>在webpack中，匹配到以/api开头的请求，将这些http请求代理到远程的后台服务。</p>
<pre><code class="language-javascript">// vue.cofig.js
const { VUE_APP_DEV_API } = process.env;
const webpackConfig = {};
if (process.env.NODE_ENV === "development") {
  webpackConfig.devServer = {
    port: 8081, // 端口号
    https: false, // https:{type:Boolean}
    open: false, // 配置自动启动浏览器,
    proxy: {
      "/api": {
        target: VUE_APP_DEV_API, // 这里是代理的目标地址
        changeOrigin: true,
        ws: true,
        // 这里是给请求添加referer,提供来源信息，后台会对此信息进行校验。
        onProxyReq: (proxyReq, req, res) => {
          proxyReq.setHeader("referer", VUE_APP_DEV_API);
        },
        pathRewrite: {
          "^/api": ""
        }
      }
    }
  };
}
module.exports = webpackConfig;
</code></pre>
<h4>文件资源调用</h4>
<p>文件下载功能封装，目前的项目中主要是有两种情况，一种是直接下载的pdf文件，还有一种是表格数据的导出。将两种方法封装在utils/index.js中。基本的原理就是模拟点击事件。</p>
<pre><code class="language-javascript">export function clickToDownload(name, url) {
  const aLink = document.createElement("a");
  const evt = document.createEvent("MouseEvents");
  evt.initMouseEvent("click", true,false,window,0,0,0,0,0,false,false,false,false,0,null);
  aLink.download = name;
  aLink.href = url;
  aLink.dispatchEvent(evt);
}

</code></pre>
<h3>逻辑层</h3>
<h4>路由的引入</h4>
<p>获取到数据之后，需要控制展示的逻辑，原本的项目中，每一个页面都是单独的文件构成，不便于维护，使用<a href="https://cn.vuejs.org/v2/guide/">Vue.js</a>框架之后，基于单文件组件搭建项目，使用<a href="https://router.vuejs.org/zh/installation.html">vue-router</a>对页面的路由进行控制，按照模块组织路由的结构，方便之后做维护，路由按照模块做<a href="https://router.vuejs.org/zh/guide/advanced/lazy-loading.html">懒加载</a>。这样在打包之后会把app.js &#x26; chunk-vendor.js 按照路由拆成几个子文件，有助于优化首屏的加载速度。</p>
<pre><code class="language-javascript">// router.js
const routes = [
  {
    path: "/",
    component: Layouts, // 部分的后台需要统一的外框，在这里设置
    children: [
      ...indexRoutes // 内部是子路由
    ]
  },
  ...HomeRoutes, // 其他不需要此layout的放在后面
  { // 错误页面的路由放在最后，因为是通配符
    path: "*",
    name: "404",
    component: ErrorComponent
  }
];
// home.js
export const HomeRoutes = [
  {
    path: "/login",
    name: "Login",
    component: () => import("@/views/login.vue") // 懒加载
  }
];
</code></pre>
<h4>引入升级</h4>
<p>随着模块的增多，需要引入的也会变多，新的方法是使用webpack的<a href="https://webpack.js.org/guides/dependency-management/#requirecontext">require.context</a>方法，参考<a href="https://www.jianshu.com/p/c894ea00dfec">https://www.jianshu.com/p/c894ea00dfec</a>。</p>
<pre><code class="language-javascript">// 有两种情况一种是在布局中的路由，放在了@/router/moudles/layouts中，
// 还有一个就是@/router/moudles
const reqLayout = require.context("./modules/layouts", false, /\.js$/);
const req = require.context("./modules", false, /\.js$/);
const requireAll = requireContext => {
  let arr = [];
  requireContext.keys().forEach(key => {
    arr = arr.concat(requireContext(key).default);
  });
  return arr;
};
const resLayout = requireAll(reqLayout);
const res = requireAll(req);

let routes = [
  {
    path: "/",
    component: Layouts,
    children: resLayout
  },
  ...res
];
</code></pre>
<p>另外此时的路由表也有调整，原本是命名的导出<code>export { Route }</code>，现在为了方便引入都改成了<code>export default</code>。</p>
<blockquote>
<p>另外此方式对于静态资源的引入也是有帮助的</p>
</blockquote>
<h4>使用</h4>
<p>使用路由的过程中可能需要用路由进行传参数，具体可以<a href="https://router.vuejs.org/zh/guide/essentials/passing-props.html">参考文档</a>，注意解耦的时候，需要在路由中添加对应的配置，解耦之后路由的参数就和组件props同样的方式使用：</p>
<pre><code class="language-javascript">const routes = [
	{
    path: "/bigdata/order/:id",
    name: "大数据-查看详情",
    component: BigdataOrderDetail,
    props: true
  },
]
// 使用的时候就是 this.id 否则是 this.$route.params.id
// query参数类似 /a?id=123&#x26;time=345
this.$route.query.id === 123
// 此外还有函数模式
{
    path: "/document",
    // name: "文档中心",
    component: Document,
    props: route => {
      return {
        focus: checkRoute(route.path)
      };
    }
}
</code></pre>
<blockquote>
<p>本次的重构中推荐使用<a href="https://router.vuejs.org/zh/guide/essentials/named-routes.html">命名路由</a>，这样路由跳转的时候是按照路由表中的name来跳转比较直观。</p>
</blockquote>
<h4>使用路由控制权限</h4>
<p>在一些后台管理系统中登录人的账号不同，其获得的权限也不同，可以在登录之后根据后台返回的权限信息对路由进行配置。一方面后台会对此进行约束，前端的方式就是使用路由守卫来进行控制。
<a href="https://router.vuejs.org/zh/guide/advanced/meta.html">参考文档-路由元信息</a></p>
<pre><code class="language-javascript">// 全局前置路由守卫 判断是否已经登录
router.beforeEach((to, from, next) => {
  if (to.matched.some(record => record.meta.requiresAuth)) {
    // this route requires auth, check if logged in
    // if not, redirect to login page.
    if (!auth.loggedIn()) {
      next({
        path: '/login',
        query: { redirect: to.fullPath }
      })
    } else {
      next()
    }
  } else {
    next() // 确保一定要调用 next()
  }
})
</code></pre>
<p>通常来说，对后台管理项目来说，可以根据路由表直接生成侧边栏结构，需要在路由的meta中对侧边栏信息进行填写 可以<a href="https://panjiachen.github.io/vue-element-admin-site/zh/guide/essentials/router-and-nav.html#%E9%85%8D%E7%BD%AE%E9%A1%B9">参考vue-element-admin</a></p>
<pre><code class="language-javascript">{
  path: '/permission',
  component: Layout,
  redirect: '/permission/index', //重定向地址，在面包屑中点击会重定向去的地址
  hidden: true, // 不在侧边栏显示
  alwaysShow: true, //一直显示根路由
  meta: { roles: ['admin','editor'] }, //在根路由设置权限,这样它下面所有的子路由都继承了这个权限
  children: [{
    path: 'index',
    component: ()=>import('permission/index'),
    name: 'permission',
    meta: {
      title: 'permission',
      icon: 'lock', //图标
      roles: ['admin','editor'], //或者你可以给每一个子路由设置自己的权限
      noCache: true // 不会被 &#x3C;keep-alive> 缓存
    }
  }]
}
</code></pre>
<h4>对可复用逻辑的封装</h4>
<p>对一些可能会使用到的逻辑进行封装，方便之后的复用</p>
<ol>
<li>点击空白部分关闭 <a href="">v-clickout</a>, 原本的方式是在每个弹框中进行配置</li>
</ol>
<pre><code class="language-javascript">// clickout
$(document).bind("click", function (e) {
    if (
         // 页面点击的时候计算一下离打开弹框和弹框本体的距离，以此判断点是否outside
         $(e.target).closest("#addRoseBox").length > 0 
      || $(e.target).closest("#addhHtyhgl").length > 0 
    ) {
    } else {
        $("#addRoseBox").hide();
    }
})
</code></pre>
<pre><code class="language-javascript">export default {
  bind(el, binding, vnode) {
    function documentHandler(e) {
      // inside
      if (el.contains(e.target)) {
        return false;
      }
      // outside call bindings
      if (binding.expression) {
        binding.value.call(this, e);
      }
    }
    el.__vueClickOutside__ = documentHandler;
    document.addEventListener("click", documentHandler);
  },
  update() {},
  unbind(el, binding) {
    document.removeEventListener("click", el.__vueClickOutside__);
    delete el.__vueClickOutside__;
  }
};
// main.js
import Clickoutside from "./directives/clickOut.js";
Vue.directive("clickout", Clickoutside);

// use
&#x3C;div v-clickout="siderShow = false" />
</code></pre>
<ol start="2">
<li><a href="https://www.jianshu.com/p/e50633a9005e">组件权限控制</a>， 逻辑也是读取router.meta中的信息来判断，指令封装的方法参考上面的clickout和<a href="https://cn.vuejs.org/v2/guide/custom-directive.html">文档</a></li>
<li>使用的ui库的封装，<a href="https://element.eleme.cn/#/zh-CN/component/quickstart#an-xu-yin-ru">按需引入组件库</a>，减少打包的体积</li>
</ol>
<pre><code class="language-javascript">// @/components/element.js
// message 等需要在具体位置引入
import Vue from "vue";
import { Button } from "element-ui";
import "@/styles/element-variables.scss"; // 样式

Vue.use(Button);
// main.js 全量import
import "./components/element.js";
</code></pre>
<pre><code class="language-css">@import "./var.scss";
/* 改变主题色变量 */
$--color-primary: $__blue;
$--color-warning: $__yellow__button;
/* 改变 icon 字体路径变量，必需 */
$--font-path: '~element-ui/lib/theme-chalk/fonts';
@import "~element-ui/packages/theme-chalk/src/index";
</code></pre>
<h4>状态管理模块</h4>
<p>这里展示一个简单的vuex的store写法，随着需要管理的状态增多可以再对store进行规范化。</p>
<pre><code class="language-javascript">import Vue from "vue";
import Vuex from "vuex";

Vue.use(Vuex);

export default new Vuex.Store({
  state: {
    example: ""
  },
  mutations: {
    updateExample(state, payload) {
      state.example = payload;
    }
  },
  actions: {
    dispatchExample({ commit }, payload) {
      commit("updateExample", payload);
    }
  },
  modules: {}
});
</code></pre>
<h3>展示层</h3>
<h4>样式处理</h4>
<p>为了能够实现样式的复用，这一次的重构选择了scss预处理器来编排项目中单文件组件的样式。</p>
<ul>
<li>默认的样式使用 scoped 修饰，防止样式污染</li>
</ul>
<pre><code>&#x3C;style lang="scss" scoped>
</code></pre>
<ul>
<li>类名称按照bem规则编写，充分利用scss的嵌套编写，这样样式能够成块，方便维护。</li>
</ul>
<pre><code class="language-css">.afin-header {
  &#x26;-wrapper {} // 这个是包裹在.afin-header之外的，也可以写在这里
  &#x26;-title {}
}
</code></pre>
<ul>
<li>通用的样式设置成mixin，方便复用，颜色等特定变量也抽出。</li>
</ul>
<pre><code class="language-css">@mixin hcenter {
	position: absolute;
	left: 50%;
	transform: translateX(-50%);
}

@include hcenter;
</code></pre>
<ul>
<li>保存上述样式的时候保存在src/styles下，文件名以一个下划线开头的，最后会被合并到index.scss文件中。</li>
<li>另外，使用element-ui的时候将自定义的样式等也放在这里的element-variables.scss中。<a href="https://element.eleme.cn/#/zh-CN/component/custom-theme#zai-xiang-mu-zhong-gai-bian-scss-bian-liang">参考</a></li>
</ul>
<p><img src="/assets/blog/vue-jquery-1.png" alt="样式文件夹"></p>
<h4>修改element-ui的样式</h4>
<p>现在我们来说说怎么覆盖 element-ui 样式。由于 element-ui 的样式我们是在全局引入的，所以你想在某个页面里面覆盖它的样式就不能加 scoped，但你又想只覆盖这个页面的 element 样式，你就可在它的父级加一个 class，用命名空间来解决问题。</p>
<pre><code class="language-css">.article-page {
  /* 你的命名空间 */
  .el-tag {
    /* element-ui 元素*/
    margin-right: 0px;
  }
}
</code></pre>
<p>当你子组件使用了 <code>scoped</code> 但在父组件又想修改子组件的样式可以 通过 <code>>>></code> 来实现：</p>
<pre><code class="language-css">&#x3C;style scoped>
.a >>> .b { /* ... */ }
&#x3C;/style>
</code></pre>
<p><code>sass</code> 你可以通过 <code>/deep/</code> 来代替 <code>>>></code> 实现想要的效果。
所以你想覆盖某个特定页面 <code>element</code> 的 button 的样式，你可以这样做：</p>
<pre><code class="language-css">/* in scss */
.xxx-container /deep/ .el-button{
  xxxx
}
</code></pre>
<h4>组件化开发</h4>
<p>常用的组件除了基于element-ui封装的组件之外，对不同的项目还会封装特定的组件，本次重构中封装了以下几个组件用于复用：</p>
<ol>
<li>回到顶部组件</li>
<li>带提示功能的输入框，选择框组件</li>
<li>树形组件等</li>
</ol>
<p>自定义组件都以Afin开头，保持独特性，方便之后汇总。</p>
<h4>静态资源引入</h4>
<ul>
<li>静态的图片等文件放在@/assets/img下，会被webpack打包，打包时<a href="https://cli.vuejs.org/zh/guide/html-and-static-assets.html#%E4%BB%8E%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E5%AF%BC%E5%85%A5">将小于 4kb 的资源内联</a>，而大的静态资源放在public文件夹中的，打包时原样复制进入build的文件中。</li>
<li>引入图片资源的时候，需要通过require引入，<strong>类似于将图片看作是一个模块</strong>。因此也可以使用import pic from "path" 的方式。</li>
<li>静态文件pdf等，放在/public文件夹里面，打包的时候会原样打包到生产包中。</li>
</ul>
<h4>echarts相关的配置</h4>
<ol>
<li>饼图默认高亮其中一个。可以使用echarts实例的dispatchAction方法</li>
</ol>
<pre><code class="language-javascript">/**
 * @description 饼图默认高亮一个
 * @author xujx
 * @date 2021-02-04
 * @export
 * @param {*} charts echarts的实例
 * @param {*} dataIndex 高亮第几个
 * @param {number} [seriesIndex=0]
 */
export function defaultHighlight(charts, dataIndex, seriesIndex = 0) {
  // 输入index超过范围就置为0
  const len = charts.getOption().series[seriesIndex].data.length;
  if (dataIndex > len - 1) {
    dataIndex = 0;
  }
  charts.dispatchAction({
    type: "highlight",
    seriesIndex: seriesIndex,
    dataIndex: dataIndex
  });
  // 当鼠标移入时，如果不是第一项，则把当前项置为选中，如果是第一项，则设置第一项为当前项
  charts.on("mouseover", function(e) {
    charts.dispatchAction({
      type: "downplay",
      seriesIndex: seriesIndex,
      dataIndex: dataIndex
    });
    const index = e.dataIndex;
    if (e.dataIndex !== index) {
      charts.dispatchAction({
        type: "downplay",
        seriesIndex: seriesIndex,
        dataIndex: index
      });
    }
    if (e.dataIndex === 0) {
      charts.dispatchAction({
        type: "highlight",
        seriesIndex: seriesIndex,
        dataIndex: e.dataIndex
      });
    }
  });

  // 当鼠标离开时，把当前项置为选中
  charts.on("mouseout", function(e) {
    charts.dispatchAction({
      type: "downplay",
      seriesIndex: seriesIndex,
      dataIndex: e.dataIndex
    });
  });
}

</code></pre>
<h2>代码风格的说明</h2>
<p>重构项目使用 eslint 约束代码的格式。关于vuejs的代码风格可以参照<a href="https://cn.vuejs.org/v2/style-guide/">风格指南</a> 。下面挑几个重点说明。</p>
<h3>暂时关闭eslint的校验</h3>
<p>如果遇到eslint报错但是这里不适合按照推荐修改的情况，可以有两种方法解决：</p>
<ol>
<li>在eslintrc.js里面，在rules里面添加一个配置关闭报错。</li>
<li>在报错位置添加魔法注释（magic comments）</li>
</ol>
<pre><code class="language-javascript">/* eslint-disable */
something with eslint error
/* eslint-enable */
</code></pre>
<h3>如何自动按照eslint标准格式化</h3>
<p>可以配置编辑器在保存的时候自动格式化，也可以手动格式化，vue cli提供了一个功能 lint 用于格式化代码</p>
<pre><code class="language-shell">yarn lint // cli 的格式化指令
</code></pre>
<h2>编写单元测试</h2>
<p>对于一些工具函数有必要编写测试方法，模板中列举了对日期格式化函数的单元测试，具体见 src/utils/formatDate。</p>
<pre><code>npm i -D jest // 安装依赖

// package.json
"script": {
   "test": "jest --coverage"
}

// .eslintrc.js
env: {
  jest: true // 避免jest测试的函数报错
},
</code></pre>
<p>运行 npm run test可以查看代码覆盖率等情况。</p>
<pre><code class="language-javascript">// const formatDate = require("./formatDate").formatDate;
// or
import { formatDate } from "./formatDate";

test("formatDate", () => {
  expect(formatDate(null, "yyyyMMdd")).toEqual("");
  expect(formatDate(new Date("2020-11-11"), "yyyyMMdd")).toEqual("20201111");
  expect(formatDate(new Date("2020-11-11 10:11:11").getTime(), "yyyyMMdd-hh:mm:ss")).toEqual(
    "20201111-10:11:11"
  );
  expect(
    formatDate(Math.floor(new Date("2020-11-11").getTime() / 1000), "yyyyMMdd")
  ).toEqual("20201111");
});

</code></pre>
<h2>项目打包的相关</h2>
<h3>配置不同的环境变量模式</h3>
<p>vue/cli中默认设置了development、production等常用的环境变量。有的时候，项目还需要一个测试的环境，或者说项目在A版本的时候需要跳转a链接，但是到了B版本的时候却需要跳转b链接，本项目中使用的是自定义一个mode=test来配置。</p>
<pre><code class="language-powershell"># .env.test 文件
NODE_ENV = production #表明打包的时候为生产环境
VUE_APP_MODE = test #表明使用的是test变量flag来进行判断
VUE_APP_PORTAL = https://v2.to.io/portal/ #也可以保存些信息
</code></pre>
<p>这样在打包的时候，可以运行<code> "build:test": "vue-cli-service build --mode test",</code>实现按照flag打包。</p>
<h3>vue.config.js</h3>
<p>最终是暴露出一个对象，所有的webpack的配置都是在这个对象中去配置的，最后通过vue/cli的merge与基本的配置合并。</p>
<pre><code class="language-javascript">const webpackConfig = {};
module.exports = webpackConfig;
</code></pre>
<h3>开启gzip</h3>
<pre><code class="language-javascript">const CompressionPlugin = require("compression-webpack-plugin");

if (process.env.NODE_ENV === "production") {
  webpackConfig["configureWebpack"] = config => {
     config["plugins"].push(
      new CompressionPlugin({
        test: /\.js$|\.html$|\.css$/, // 匹配文件名
        threshold: 10240, // 对超过10k的数据压缩
        deleteOriginalAssets: true
      })
    );
  }
}
</code></pre>
<h3>图片压缩</h3>
<pre><code class="language-javascript">const customOptions = {
  mozjpeg: {
    progressive: true,
    quality: 50
  },
  optipng: {
    enabled: true
  },
  pngquant: {
    quality: [0.5, 0.65],
    speed: 4
  },
  gifsicle: {
    interlaced: false
  },
  // 不支持WEBP就不要写这一项
  webp: {
    quality: 75
  }
};
if (process.env.NODE_ENV === "production") {
  webpackConfig["chainWebpack"] = config => {
    config.module
      .rule("images")
      .test(/\.(gif|png|jpe?g|svg)$/i)
      .use("image-webpack-loader")
      .loader("image-webpack-loader")
      .options(customOptions)
      .end();
  };
}  
</code></pre>
<h3>关闭sourceMap</h3>
<pre><code class="language-javascript">const webpackConfig = {
  // 生产环境关闭sourceMap
  productionSourceMap: false
};
</code></pre>
<h3>查看打包优化的包体积</h3>
<pre><code class="language-javascript">const BundleAnalyzerPlugin = require("webpack-bundle-analyzer")
  .BundleAnalyzerPlugin;
if (process.env.NODE_ENV === "production") {
  webpackConfig["configureWebpack"] = config => {
    config["plugins"].push(
      new BundleAnalyzerPlugin({
        analyzerMode: "static",
        openAnalyzer: false,
        reportFilename: `../reports/r-${new Date().getTime()}.html`
      })
    );
  }  
}
// 可以把/reports加入 .gitignore
</code></pre>
<h3>webpack-devSever</h3>
<pre><code class="language-javascript">const { VUE_APP_DEV_API } = process.env;
if (process.env.NODE_ENV === "development") {
  webpackConfig.devServer = {
    // port: 8081, // 端口号
    https: false, // https:{type:Boolean}
    open: false, // 配置自动启动浏览器,
    proxy: {
      "/api": {
        target: VUE_APP_DEV_API,
        changeOrigin: true,
        ws: true,
        onProxyReq: (proxyReq, req, res) => {
          proxyReq.setHeader("referer", VUE_APP_DEV_API);
        },
        pathRewrite: {
          "^/api": ""
        }
      }
    }
  };
}
</code></pre>
<h2>前端开发脚手架</h2>
<h2>参考文章</h2>
<p><a href="https://woai3c.gitee.io/introduction-to-front-end-engineering/03.html#%E9%AB%98%E5%86%85%E8%81%9A-%E4%BD%8E%E8%80%A6%E5%90%88">入门前端工程化</a>
<a href="https://panjiachen.gitee.io/vue-element-admin-site/zh/">vue-element-admin</a></p>
</div><div id="comments"></div></div><div class="Footer__FooterWrapper-sc-1ysspqt-0 dduiPc"><div class="my-main-font text"><span>Powerd by Next.js on gh-pages, </span><a href="http://www.anbandon.work">More in old blog</a></div><div class="Footer__IconList-sc-1ysspqt-1 iXsBAW"><a href="https://github.com/alfxjx"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><defs><style></style></defs><path d="M960 512c0 97.76-28.704 185.216-85.664 263.264-56.96 78.016-130.496 131.84-220.64 161.856-10.304 1.824-18.368.448-22.848-4.032a22.4 22.4 0 0 1-7.2-17.504v-122.88c0-37.632-10.304-65.44-30.464-82.912a409.856 409.856 0 0 0 59.616-10.368 222.752 222.752 0 0 0 54.72-22.816c18.848-10.784 34.528-23.36 47.104-38.592 12.544-15.232 22.848-35.904 30.912-61.44 8.096-25.568 12.128-54.688 12.128-87.904 0-47.072-15.232-86.976-46.208-120.16 14.368-35.456 13.024-74.912-4.48-118.848-10.752-3.616-26.432-1.344-47.072 6.272s-38.56 16.16-53.824 25.568l-21.984 13.888C587.776 285.088 550.56 280.16 512 280.16s-75.776 4.928-112.096 15.232a444.48 444.48 0 0 0-24.672-15.68c-10.336-6.272-26.464-13.888-48.896-22.432-21.952-8.96-39.008-11.232-50.24-8.064-17.024 43.936-18.368 83.424-4.032 118.848-30.496 33.632-46.176 73.536-46.176 120.608 0 33.216 4.032 62.336 12.128 87.456 8.032 25.12 18.368 45.76 30.496 61.44 12.544 15.68 28.224 28.704 47.072 39.04 18.848 10.304 37.216 17.92 54.72 22.816a409.6 409.6 0 0 0 59.648 10.368c-15.712 13.856-25.12 34.048-28.704 60.064a99.744 99.744 0 0 1-26.464 8.512 178.208 178.208 0 0 1-33.184 2.688c-13.024 0-25.568-4.032-38.144-12.544-12.544-8.512-23.296-20.64-32.256-36.32a97.472 97.472 0 0 0-28.256-30.496c-11.232-8.064-21.088-12.576-28.704-13.92l-11.648-1.792c-8.096 0-13.92.928-17.056 2.688-3.136 1.792-4.032 4.032-2.688 6.72s3.136 5.408 5.376 8.096 4.928 4.928 7.616 7.168l4.032 2.688c8.544 4.032 17.056 11.232 25.568 21.984 8.544 10.752 14.368 20.64 18.4 29.6l5.824 13.44c4.928 14.816 13.44 26.912 25.568 35.872 12.096 8.992 25.088 14.816 39.008 17.504 13.888 2.688 27.36 4.032 40.352 4.032s23.776-.448 32.288-2.24l13.472-2.24c0 14.784 0 32.288.416 52.032 0 19.744.48 30.496.48 31.392a22.624 22.624 0 0 1-7.648 17.472c-4.928 4.48-12.992 5.824-23.296 4.032-90.144-30.048-163.68-83.84-220.64-161.888C92.256 697.216 64 609.312 64 512c0-81.152 20.192-156.064 60.096-224.672s94.176-122.88 163.232-163.232C355.936 84.192 430.816 64 512 64s156.064 20.192 224.672 60.096 122.88 94.176 163.232 163.232C939.808 355.488 960 430.848 960 512"></path></svg></a><a href="https://weibo.com/u/1950371745"><svg class="icon" viewBox="0 0 1026 1024" xmlns="http://www.w3.org/2000/svg" width="32.063" height="32"><defs><style></style></defs><path d="M0 61.5zM780 577c-11-2-18-5.5-21-9.5-3-4.5-4-8-1.5-12l3-5.5c.5-.5 1.5-2 2-3 .5-1.5 2-4.5 4.5-9 2-4.5 4-9.5 5-14s2-10.5 2.5-17 .5-13.5-.5-19.5-3-12.5-6.5-20c-3.5-7-7.5-13.5-13.5-19.5-10-10-23-16.5-39.5-19.5-16-3-32.5-3-48.5-.5s-31.5 5.5-45.5 9.5c-14.5 4-26 7.5-35.5 11.5l-14 6.5c-7 2-13 3.5-18 4.5-4.5.5-8.5.5-11-.5s-4.5-2-6-3-2-3.5-1.5-7.5.5-7.5 1-10c.5-3 1.5-7.5 2.5-13.5 1.5-6 2.5-11 3-14.5 0-8.5-.5-16.5-1.5-24s-3.5-16-7-25.5-9-17-15.5-22.5c-7-5.5-15.5-10.5-26-14s-24-4.5-40.5-3-35 5.5-56 13c-25 8.5-50.5 21.5-76.5 38-26 17-48 34.5-67 52.5-19 18.5-36.5 36-52 53.5-16 17-28 31-36.5 42l-12 17c-23.5 31-41 61.5-52.5 92.5s-17 54-16 70V723c4.5 34.5 15 65.5 31.5 92.5 17 27.5 37 49.5 60 66 23.5 17 51 31 82.5 43s62 20.5 91 26 59.5 9 92 11.5c53 4.5 108 0 165-12.5s110-34.5 159-65c49-31 84-68 104-111 12-25 18.5-49 19-71s-3.5-40.5-11.5-54.5-18-26.5-30.5-37c-12.5-11-24.5-18.5-35.5-23.5-10-6-20-9.5-28.5-10.5zM452 911.5c-77.5 3.5-143.5-11.5-197.5-45s-81-76.5-81-128c0-51 27-95 80.5-132s120-57 198-61S596 555 650 584s80.5 69.5 80.5 120.5c0 51.5-27.5 98-82.5 139.5s-120 64-196 67.5zm-31.5-298c-21 2-39.5 7-56 14.5S335 644 326 654c-9.5 9.5-17 20-23.5 31s-11 22-13.5 33-4 20.5-5 29.5c-.5 9-1 16-1 21l1 8.5v4.5c0 2 .5 6.5 2 13s3.5 12.5 6 18 6.5 11.5 12.5 18 12.5 12 20.5 16c47.5 23 91.5 30 132.5 21s74-29.5 99-62c10-12 16.5-27.5 20-45 3-18 2.5-36-2-54.5s-12.5-35-24-50-28.5-26.5-51-35c-23.5-9-49.5-11-79-7.5zM382 817c-4.5.5-8.5 1-12.5.5s-7.5-1-11-2-6.5-2.5-9.5-4-6-3.5-8-6l-6-7.5c-2-2.5-3-5.5-4.5-8.5s-1.5-6.5-1.5-10c0-8 2-15.5 6.5-23s10-14 18-19.5c7.5-5.5 16-8.5 25.5-9 6.5-.5 12.5-.5 19 .5 6 1 11.5 3 15.5 5.5 4.5 2.5 8 5.5 11.5 8.5 3 3 5.5 7 7 11.5s2 9 2 14c0 8-2.5 15.5-7 22.5S416 804 408 809c-8 4-16.5 7-26 8zm91.5-77.5c-5 3.5-10 5-15.5 5-5.5-.5-9-2.5-11.5-7l-2-4.5c-.5-1.5-1-3-1-4.5V724c0-2 .5-4 1-5.5l2-4.5c.5-1.5 2-2.5 3-3l3-4.5c5.5-4.5 11.5-6 16.5-5.5s9 3.5 11.5 8.5c2 3 3 6 2.5 9.5s-1.5 7-3 10c-1.5 4.5-4 7.5-6.5 10.5zm382-225c4.5 0 8.5-1 12-3s6.5-5 8.5-8 3.5-6.5 4.5-10c.5-.5 1-2 1-3 8.5-82-20-128.5-86-140-19.5-3.5-37.5-4-54-1-5 0-9.5 1.5-13 4s-6.5 5.5-9 9.5-4 8-4 12.5c0 7 2.5 13.5 7.5 18.5s11 7.5 18.5 7.5c56-13 86 5 90.5 54 1.5 12 .5 23.5-2 34.5 0 7 2.5 13.5 7.5 18.5 4.5 3.5 10.5 6 18 6zM837 211c-31.5-7-74-5.5-127 4.5-.5 0-1.5.5-2 1l-1 2-1 1c-8 2-14.5 6.5-19.5 13.5s-7.5 14-7.5 22c0 11 3.5 19.5 11 27 7 7 16 11 26 11h3c.5 0 2.5-.5 5-1s5-1.5 8-1.5c3-.5 6-1 9-2s6-2 8.5-3S757 284 764 284s16 .5 26.5 1.5 22 4 34.5 8c12.5 4.5 25 9.5 37.5 16s25 15.5 37.5 27 23.5 24.5 33 40c18.5 42.5 22.5 83 11 122.5 0 .5 0 1.5-.5 2s-1 2.5-1.5 5.5-1.5 5.5-2 8-1.5 5.5-2 9.5-1 7.5-1 10c0 6.5 2 12 5.5 16 3.5 4.5 8 7.5 13.5 9 5.5 2 11.5 2.5 19 2.5 20 0 32-12 35.5-36.5 8.5-28 13.5-54.5 14.5-80s-.5-48-5.5-67c-4.5-19.5-11.5-37.5-21-54.5s-20-31-32.5-43c-12-12-26-22.5-41-32.5-15-9.5-29.5-17.5-43.5-23-15-5.5-29.5-10.5-44.5-14z"></path></svg></a><a href="https://juejin.cn/user/2330620383728551"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><defs><style></style></defs><path d="M832 739.533h57.958v30.105H587.571v-30.105h48.538l-31.54-184.525-.819-4.506 4.608-.716 21.095-3.482 4.505-.717.82 4.506 32.46 189.645h49.87V510.874H571.391v-30.106h145.613V381.44H619.93v-30.106h228.556v30.106H747.52v99.328h162.918v30.106H747.622v228.659h53.453l32.461-189.543.717-4.505 4.505.717 21.095 3.481 4.608.717-.82 4.506L832 739.533zm-428.032-9.728V582.45h74.854V423.22h-30.617v129.127h-44.237V413.798H373.35v138.548h-43.52V423.219h-30.617v159.232h74.137v147.354h-43.52V602.624h-30.617V759.91H478.72V602.624h-30.618v127.18h-44.134zM148.89 582.45l-21.607 21.197-3.174 3.174-3.175-3.174L105.78 588.8l-3.379-3.277 3.38-3.277 43.11-42.393V364.237h-37.684V334.13h37.684V254.26h30.617v79.872h44.135v30.106h-44.135v145.715l25.6-25.088 3.175-3.174 3.174 3.174 15.155 14.746 3.38 3.276-3.38 3.277-47.104 46.285v65.024c0 33.178-5.12 65.024-13.824 94.413-5.325 18.022-10.547 31.13-14.745 39.629l-4.71 9.42-2.049 3.994-4.096-1.946-19.251-9.113-4.198-2.048 2.048-4.199 4.608-9.42c.716-1.332 2.252-4.813 3.993-9.319 2.97-7.475 5.94-15.974 8.704-25.497 7.885-26.932 12.698-56.013 12.698-86.016V582.45zm97.792 180.122l.921-4.506 2.15-10.24c12.8-61.645 17.511-195.584 16.999-358.605h220.672v-134.86H234.496l.102 4.71.205 10.65c.205 10.24.615 32.768.82 59.904.409 44.748.511 91.033.102 136.601-1.229 129.536-6.144 227.84-16.077 275.559l-2.15 10.24-.922 4.505 4.506.922 20.992 4.198 4.608.922zm19.865-403.456l-1.024-74.65h191.181v74.65H266.547zm634.266 31.437l3.072-3.277 14.54-15.36 3.175-3.38-3.482-3.174-121.344-109.875-3.072-1.229h-126.77l-3.073 1.229-121.241 109.875-3.482 3.175 3.174 3.379 14.541 15.36 3.072 3.277 3.38-2.97 115.2-103.014h103.833l115.2 103.014 3.277 2.97z"></path></svg></a></div></div></div><div class="Toast__StyledContainer-sc-1p228qg-0 iqCFQa"><div class="Toastify"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"[Vue]前端项目重构小记","date":"2021-04-13T16:35:07.322Z","slug":"refactor-vue","author":{"name":"Alfxjx","picture":"/assets/authors/alfxjx.jpg"},"content":"\u003ch2\u003e重构目标\u003c/h2\u003e\n\u003cp\u003e原有的旧项目原本时前后端不分离的，在开发过程中对前端开发人员需要全项目启动，比较麻烦，同时项目在进行前后端分离之后，前端部分开发使用的时http-server启动服务，不支持\u003ca href=\"https://www.webpackjs.com/concepts/hot-module-replacement/\"\u003eHMR\u003c/a\u003e，修改完成之后需要手动刷新。另外，原本的项目采用的基于jQuery的传统技术栈，在之后项目的迭代升级中，制约了项目的开发。因此开始了本次的前端项目重构。\u003c/p\u003e\n\u003cp\u003e重构的目标是将原本组合在一起的官网项目和客户自服务项目按照其功能分成两块。\u003c/p\u003e\n\u003cp\u003e通过此次重构为之后重构运营管理平台积累经验。\u003c/p\u003e\n\u003ch2\u003e项目结构\u003c/h2\u003e\n\u003ch3\u003e数据层\u003c/h3\u003e\n\u003ch4\u003eaxios封装\u003c/h4\u003e\n\u003cp\u003e数据层原先存在的问题是，ajax请求分布在项目中，例如每进入一个页面都会请求的数据（logUser），事实上是在所有的页面中都重写了一次的逻辑，分散的逻辑不利于后期的维护，以及换人开发的时候上手会比较困难。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/blog/vue-jquery-0.png\" alt=\"平均一个文件两个请求\"\u003e\u003c/p\u003e\n\u003cp\u003e重构的项目中改善了此问题，方法就是统一管理请求，包括请求的处理以及请求方法的位置。基于webpack打包环境，引入axios，并对axios做一定的封装，实现：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e在发送请求之前和接收数据的时候统一处理\u003c/li\u003e\n\u003cli\u003e优化体验加上loading的过度效果，\u003c/li\u003e\n\u003cli\u003e对于某些需要用户登录权限的接口在拦截器中获取登录的权限并保持住登录状态。\u003c/li\u003e\n\u003cli\u003e根据环境变量控制请求的接口地址。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e这些改进需要配合后端的重构逐步实施，因为现在后台的请求不是完全统一，在后面的重构过程中需要将后台的返回统一化，这样也方便对数据的处理。目前针对此情况，对现有的接口做了一定的分类，按照请求的类型使用不同的axios实例具体可以参考\u003ca href=\"\"\u003e代码\u003c/a\u003e, \u003cstrong\u003e在拦截器中使用MessageBox的单例模式（伪）参考\u003c/strong\u003e\u003ca href=\"https://www.yuque.com/alfxjx/gihbyq/odw8bw#rwKl0\"\u003e我的笔记本的这个链接\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst baseUrl = NODE_ENV === \"development\" ? \"/api\" : `${VUE_APP_PROD_API}`;\n\nconst axiosInstance = axios.create({\n  baseURL: baseUrl\n  // timeout: 30000,\n});\n// 请求拦截器，在发送之前对数据操作\naxiosInstance.interceptors.request.use(function(config) {\n  loadingInstance = Loading.service({\n    fullscreen: true,\n    lock: true,\n    background: \"transparent\"\n  });\n  config.headers.authorization = sessionStorage.getItem(\"token\");\n  return config;\n});\n// 响应拦截\naxiosInstance.interceptors.response.use(\n  res =\u003e {\n    clearTimeout(clearLoading);\n    // 判断失误请求 httpCode=200\n    if (res.data.code !== 0) {\n      // ...\n      loadingInstance.close();\n      return;\n    }\n    // 拦截返回值里面的新的token，用于刷新保持登录态。\n    // 大小写敏感\n    const newToken = res.headers.authorization;\n    // console.log(newToken);\n    if (newToken) {\n      sessionStorage.setItem(\"token\", newToken);\n    }\n    loadingInstance.close();\n    return res.data;\n  },\n  err =\u003e {\n    // ...\n    loadingInstance.close();\n  }\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e重构的项目中使用 axios 对 http 请求进行了封装，默认是json格式的参数对象格式，对于某些未使用json格式对象的，暴露出一个基本axios请求对象实例，另外对于原始项目中较多的 form 请求格式，暴露一个form格式post请求函数。注意此函数需要对参数进行QS.stringfy()。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// 对于某些使用form格式接口的适配\nfunction axiosFormRequest(url, data) {\n  return axiosBase.post(url, Qs.stringify(data), {\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded; charset=utf-8;\"\n    }\n  });\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e请求根据环境变量配置不同的链接\u003c/h4\u003e\n\u003cp\u003e由于开发过程中，在本地启动，所以http请求会跨域，因此需要webpack的devServer对请求做一次转发，解决跨域问题：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// axios config.js\n// dev环境下统一添加一个前缀/api,用以区分http请求和其他请求。\nconst { NODE_ENV, VUE_APP_PROD_API } = process.env;\nconst baseUrl = NODE_ENV === \"development\" ? \"/api\" : `${VUE_APP_PROD_API}`;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e在webpack中，匹配到以/api开头的请求，将这些http请求代理到远程的后台服务。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// vue.cofig.js\nconst { VUE_APP_DEV_API } = process.env;\nconst webpackConfig = {};\nif (process.env.NODE_ENV === \"development\") {\n  webpackConfig.devServer = {\n    port: 8081, // 端口号\n    https: false, // https:{type:Boolean}\n    open: false, // 配置自动启动浏览器,\n    proxy: {\n      \"/api\": {\n        target: VUE_APP_DEV_API, // 这里是代理的目标地址\n        changeOrigin: true,\n        ws: true,\n        // 这里是给请求添加referer,提供来源信息，后台会对此信息进行校验。\n        onProxyReq: (proxyReq, req, res) =\u003e {\n          proxyReq.setHeader(\"referer\", VUE_APP_DEV_API);\n        },\n        pathRewrite: {\n          \"^/api\": \"\"\n        }\n      }\n    }\n  };\n}\nmodule.exports = webpackConfig;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e文件资源调用\u003c/h4\u003e\n\u003cp\u003e文件下载功能封装，目前的项目中主要是有两种情况，一种是直接下载的pdf文件，还有一种是表格数据的导出。将两种方法封装在utils/index.js中。基本的原理就是模拟点击事件。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eexport function clickToDownload(name, url) {\n  const aLink = document.createElement(\"a\");\n  const evt = document.createEvent(\"MouseEvents\");\n  evt.initMouseEvent(\"click\", true,false,window,0,0,0,0,0,false,false,false,false,0,null);\n  aLink.download = name;\n  aLink.href = url;\n  aLink.dispatchEvent(evt);\n}\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e逻辑层\u003c/h3\u003e\n\u003ch4\u003e路由的引入\u003c/h4\u003e\n\u003cp\u003e获取到数据之后，需要控制展示的逻辑，原本的项目中，每一个页面都是单独的文件构成，不便于维护，使用\u003ca href=\"https://cn.vuejs.org/v2/guide/\"\u003eVue.js\u003c/a\u003e框架之后，基于单文件组件搭建项目，使用\u003ca href=\"https://router.vuejs.org/zh/installation.html\"\u003evue-router\u003c/a\u003e对页面的路由进行控制，按照模块组织路由的结构，方便之后做维护，路由按照模块做\u003ca href=\"https://router.vuejs.org/zh/guide/advanced/lazy-loading.html\"\u003e懒加载\u003c/a\u003e。这样在打包之后会把app.js \u0026#x26; chunk-vendor.js 按照路由拆成几个子文件，有助于优化首屏的加载速度。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// router.js\nconst routes = [\n  {\n    path: \"/\",\n    component: Layouts, // 部分的后台需要统一的外框，在这里设置\n    children: [\n      ...indexRoutes // 内部是子路由\n    ]\n  },\n  ...HomeRoutes, // 其他不需要此layout的放在后面\n  { // 错误页面的路由放在最后，因为是通配符\n    path: \"*\",\n    name: \"404\",\n    component: ErrorComponent\n  }\n];\n// home.js\nexport const HomeRoutes = [\n  {\n    path: \"/login\",\n    name: \"Login\",\n    component: () =\u003e import(\"@/views/login.vue\") // 懒加载\n  }\n];\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e引入升级\u003c/h4\u003e\n\u003cp\u003e随着模块的增多，需要引入的也会变多，新的方法是使用webpack的\u003ca href=\"https://webpack.js.org/guides/dependency-management/#requirecontext\"\u003erequire.context\u003c/a\u003e方法，参考\u003ca href=\"https://www.jianshu.com/p/c894ea00dfec\"\u003ehttps://www.jianshu.com/p/c894ea00dfec\u003c/a\u003e。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// 有两种情况一种是在布局中的路由，放在了@/router/moudles/layouts中，\n// 还有一个就是@/router/moudles\nconst reqLayout = require.context(\"./modules/layouts\", false, /\\.js$/);\nconst req = require.context(\"./modules\", false, /\\.js$/);\nconst requireAll = requireContext =\u003e {\n  let arr = [];\n  requireContext.keys().forEach(key =\u003e {\n    arr = arr.concat(requireContext(key).default);\n  });\n  return arr;\n};\nconst resLayout = requireAll(reqLayout);\nconst res = requireAll(req);\n\nlet routes = [\n  {\n    path: \"/\",\n    component: Layouts,\n    children: resLayout\n  },\n  ...res\n];\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e另外此时的路由表也有调整，原本是命名的导出\u003ccode\u003eexport { Route }\u003c/code\u003e，现在为了方便引入都改成了\u003ccode\u003eexport default\u003c/code\u003e。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e另外此方式对于静态资源的引入也是有帮助的\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4\u003e使用\u003c/h4\u003e\n\u003cp\u003e使用路由的过程中可能需要用路由进行传参数，具体可以\u003ca href=\"https://router.vuejs.org/zh/guide/essentials/passing-props.html\"\u003e参考文档\u003c/a\u003e，注意解耦的时候，需要在路由中添加对应的配置，解耦之后路由的参数就和组件props同样的方式使用：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst routes = [\n\t{\n    path: \"/bigdata/order/:id\",\n    name: \"大数据-查看详情\",\n    component: BigdataOrderDetail,\n    props: true\n  },\n]\n// 使用的时候就是 this.id 否则是 this.$route.params.id\n// query参数类似 /a?id=123\u0026#x26;time=345\nthis.$route.query.id === 123\n// 此外还有函数模式\n{\n    path: \"/document\",\n    // name: \"文档中心\",\n    component: Document,\n    props: route =\u003e {\n      return {\n        focus: checkRoute(route.path)\n      };\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e本次的重构中推荐使用\u003ca href=\"https://router.vuejs.org/zh/guide/essentials/named-routes.html\"\u003e命名路由\u003c/a\u003e，这样路由跳转的时候是按照路由表中的name来跳转比较直观。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4\u003e使用路由控制权限\u003c/h4\u003e\n\u003cp\u003e在一些后台管理系统中登录人的账号不同，其获得的权限也不同，可以在登录之后根据后台返回的权限信息对路由进行配置。一方面后台会对此进行约束，前端的方式就是使用路由守卫来进行控制。\n\u003ca href=\"https://router.vuejs.org/zh/guide/advanced/meta.html\"\u003e参考文档-路由元信息\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// 全局前置路由守卫 判断是否已经登录\nrouter.beforeEach((to, from, next) =\u003e {\n  if (to.matched.some(record =\u003e record.meta.requiresAuth)) {\n    // this route requires auth, check if logged in\n    // if not, redirect to login page.\n    if (!auth.loggedIn()) {\n      next({\n        path: '/login',\n        query: { redirect: to.fullPath }\n      })\n    } else {\n      next()\n    }\n  } else {\n    next() // 确保一定要调用 next()\n  }\n})\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e通常来说，对后台管理项目来说，可以根据路由表直接生成侧边栏结构，需要在路由的meta中对侧边栏信息进行填写 可以\u003ca href=\"https://panjiachen.github.io/vue-element-admin-site/zh/guide/essentials/router-and-nav.html#%E9%85%8D%E7%BD%AE%E9%A1%B9\"\u003e参考vue-element-admin\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e{\n  path: '/permission',\n  component: Layout,\n  redirect: '/permission/index', //重定向地址，在面包屑中点击会重定向去的地址\n  hidden: true, // 不在侧边栏显示\n  alwaysShow: true, //一直显示根路由\n  meta: { roles: ['admin','editor'] }, //在根路由设置权限,这样它下面所有的子路由都继承了这个权限\n  children: [{\n    path: 'index',\n    component: ()=\u003eimport('permission/index'),\n    name: 'permission',\n    meta: {\n      title: 'permission',\n      icon: 'lock', //图标\n      roles: ['admin','editor'], //或者你可以给每一个子路由设置自己的权限\n      noCache: true // 不会被 \u0026#x3C;keep-alive\u003e 缓存\n    }\n  }]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e对可复用逻辑的封装\u003c/h4\u003e\n\u003cp\u003e对一些可能会使用到的逻辑进行封装，方便之后的复用\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e点击空白部分关闭 \u003ca href=\"\"\u003ev-clickout\u003c/a\u003e, 原本的方式是在每个弹框中进行配置\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// clickout\n$(document).bind(\"click\", function (e) {\n    if (\n         // 页面点击的时候计算一下离打开弹框和弹框本体的距离，以此判断点是否outside\n         $(e.target).closest(\"#addRoseBox\").length \u003e 0 \n      || $(e.target).closest(\"#addhHtyhgl\").length \u003e 0 \n    ) {\n    } else {\n        $(\"#addRoseBox\").hide();\n    }\n})\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eexport default {\n  bind(el, binding, vnode) {\n    function documentHandler(e) {\n      // inside\n      if (el.contains(e.target)) {\n        return false;\n      }\n      // outside call bindings\n      if (binding.expression) {\n        binding.value.call(this, e);\n      }\n    }\n    el.__vueClickOutside__ = documentHandler;\n    document.addEventListener(\"click\", documentHandler);\n  },\n  update() {},\n  unbind(el, binding) {\n    document.removeEventListener(\"click\", el.__vueClickOutside__);\n    delete el.__vueClickOutside__;\n  }\n};\n// main.js\nimport Clickoutside from \"./directives/clickOut.js\";\nVue.directive(\"clickout\", Clickoutside);\n\n// use\n\u0026#x3C;div v-clickout=\"siderShow = false\" /\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e\u003ca href=\"https://www.jianshu.com/p/e50633a9005e\"\u003e组件权限控制\u003c/a\u003e， 逻辑也是读取router.meta中的信息来判断，指令封装的方法参考上面的clickout和\u003ca href=\"https://cn.vuejs.org/v2/guide/custom-directive.html\"\u003e文档\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e使用的ui库的封装，\u003ca href=\"https://element.eleme.cn/#/zh-CN/component/quickstart#an-xu-yin-ru\"\u003e按需引入组件库\u003c/a\u003e，减少打包的体积\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// @/components/element.js\n// message 等需要在具体位置引入\nimport Vue from \"vue\";\nimport { Button } from \"element-ui\";\nimport \"@/styles/element-variables.scss\"; // 样式\n\nVue.use(Button);\n// main.js 全量import\nimport \"./components/element.js\";\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-css\"\u003e@import \"./var.scss\";\n/* 改变主题色变量 */\n$--color-primary: $__blue;\n$--color-warning: $__yellow__button;\n/* 改变 icon 字体路径变量，必需 */\n$--font-path: '~element-ui/lib/theme-chalk/fonts';\n@import \"~element-ui/packages/theme-chalk/src/index\";\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e状态管理模块\u003c/h4\u003e\n\u003cp\u003e这里展示一个简单的vuex的store写法，随着需要管理的状态增多可以再对store进行规范化。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eimport Vue from \"vue\";\nimport Vuex from \"vuex\";\n\nVue.use(Vuex);\n\nexport default new Vuex.Store({\n  state: {\n    example: \"\"\n  },\n  mutations: {\n    updateExample(state, payload) {\n      state.example = payload;\n    }\n  },\n  actions: {\n    dispatchExample({ commit }, payload) {\n      commit(\"updateExample\", payload);\n    }\n  },\n  modules: {}\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e展示层\u003c/h3\u003e\n\u003ch4\u003e样式处理\u003c/h4\u003e\n\u003cp\u003e为了能够实现样式的复用，这一次的重构选择了scss预处理器来编排项目中单文件组件的样式。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e默认的样式使用 scoped 修饰，防止样式污染\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026#x3C;style lang=\"scss\" scoped\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e类名称按照bem规则编写，充分利用scss的嵌套编写，这样样式能够成块，方便维护。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-css\"\u003e.afin-header {\n  \u0026#x26;-wrapper {} // 这个是包裹在.afin-header之外的，也可以写在这里\n  \u0026#x26;-title {}\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e通用的样式设置成mixin，方便复用，颜色等特定变量也抽出。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-css\"\u003e@mixin hcenter {\n\tposition: absolute;\n\tleft: 50%;\n\ttransform: translateX(-50%);\n}\n\n@include hcenter;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e保存上述样式的时候保存在src/styles下，文件名以一个下划线开头的，最后会被合并到index.scss文件中。\u003c/li\u003e\n\u003cli\u003e另外，使用element-ui的时候将自定义的样式等也放在这里的element-variables.scss中。\u003ca href=\"https://element.eleme.cn/#/zh-CN/component/custom-theme#zai-xiang-mu-zhong-gai-bian-scss-bian-liang\"\u003e参考\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/assets/blog/vue-jquery-1.png\" alt=\"样式文件夹\"\u003e\u003c/p\u003e\n\u003ch4\u003e修改element-ui的样式\u003c/h4\u003e\n\u003cp\u003e现在我们来说说怎么覆盖 element-ui 样式。由于 element-ui 的样式我们是在全局引入的，所以你想在某个页面里面覆盖它的样式就不能加 scoped，但你又想只覆盖这个页面的 element 样式，你就可在它的父级加一个 class，用命名空间来解决问题。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-css\"\u003e.article-page {\n  /* 你的命名空间 */\n  .el-tag {\n    /* element-ui 元素*/\n    margin-right: 0px;\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e当你子组件使用了 \u003ccode\u003escoped\u003c/code\u003e 但在父组件又想修改子组件的样式可以 通过 \u003ccode\u003e\u003e\u003e\u003e\u003c/code\u003e 来实现：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-css\"\u003e\u0026#x3C;style scoped\u003e\n.a \u003e\u003e\u003e .b { /* ... */ }\n\u0026#x3C;/style\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003esass\u003c/code\u003e 你可以通过 \u003ccode\u003e/deep/\u003c/code\u003e 来代替 \u003ccode\u003e\u003e\u003e\u003e\u003c/code\u003e 实现想要的效果。\n所以你想覆盖某个特定页面 \u003ccode\u003eelement\u003c/code\u003e 的 button 的样式，你可以这样做：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-css\"\u003e/* in scss */\n.xxx-container /deep/ .el-button{\n  xxxx\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e组件化开发\u003c/h4\u003e\n\u003cp\u003e常用的组件除了基于element-ui封装的组件之外，对不同的项目还会封装特定的组件，本次重构中封装了以下几个组件用于复用：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e回到顶部组件\u003c/li\u003e\n\u003cli\u003e带提示功能的输入框，选择框组件\u003c/li\u003e\n\u003cli\u003e树形组件等\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e自定义组件都以Afin开头，保持独特性，方便之后汇总。\u003c/p\u003e\n\u003ch4\u003e静态资源引入\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e静态的图片等文件放在@/assets/img下，会被webpack打包，打包时\u003ca href=\"https://cli.vuejs.org/zh/guide/html-and-static-assets.html#%E4%BB%8E%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E5%AF%BC%E5%85%A5\"\u003e将小于 4kb 的资源内联\u003c/a\u003e，而大的静态资源放在public文件夹中的，打包时原样复制进入build的文件中。\u003c/li\u003e\n\u003cli\u003e引入图片资源的时候，需要通过require引入，\u003cstrong\u003e类似于将图片看作是一个模块\u003c/strong\u003e。因此也可以使用import pic from \"path\" 的方式。\u003c/li\u003e\n\u003cli\u003e静态文件pdf等，放在/public文件夹里面，打包的时候会原样打包到生产包中。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003eecharts相关的配置\u003c/h4\u003e\n\u003col\u003e\n\u003cli\u003e饼图默认高亮其中一个。可以使用echarts实例的dispatchAction方法\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e/**\n * @description 饼图默认高亮一个\n * @author xujx\n * @date 2021-02-04\n * @export\n * @param {*} charts echarts的实例\n * @param {*} dataIndex 高亮第几个\n * @param {number} [seriesIndex=0]\n */\nexport function defaultHighlight(charts, dataIndex, seriesIndex = 0) {\n  // 输入index超过范围就置为0\n  const len = charts.getOption().series[seriesIndex].data.length;\n  if (dataIndex \u003e len - 1) {\n    dataIndex = 0;\n  }\n  charts.dispatchAction({\n    type: \"highlight\",\n    seriesIndex: seriesIndex,\n    dataIndex: dataIndex\n  });\n  // 当鼠标移入时，如果不是第一项，则把当前项置为选中，如果是第一项，则设置第一项为当前项\n  charts.on(\"mouseover\", function(e) {\n    charts.dispatchAction({\n      type: \"downplay\",\n      seriesIndex: seriesIndex,\n      dataIndex: dataIndex\n    });\n    const index = e.dataIndex;\n    if (e.dataIndex !== index) {\n      charts.dispatchAction({\n        type: \"downplay\",\n        seriesIndex: seriesIndex,\n        dataIndex: index\n      });\n    }\n    if (e.dataIndex === 0) {\n      charts.dispatchAction({\n        type: \"highlight\",\n        seriesIndex: seriesIndex,\n        dataIndex: e.dataIndex\n      });\n    }\n  });\n\n  // 当鼠标离开时，把当前项置为选中\n  charts.on(\"mouseout\", function(e) {\n    charts.dispatchAction({\n      type: \"downplay\",\n      seriesIndex: seriesIndex,\n      dataIndex: e.dataIndex\n    });\n  });\n}\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e代码风格的说明\u003c/h2\u003e\n\u003cp\u003e重构项目使用 eslint 约束代码的格式。关于vuejs的代码风格可以参照\u003ca href=\"https://cn.vuejs.org/v2/style-guide/\"\u003e风格指南\u003c/a\u003e 。下面挑几个重点说明。\u003c/p\u003e\n\u003ch3\u003e暂时关闭eslint的校验\u003c/h3\u003e\n\u003cp\u003e如果遇到eslint报错但是这里不适合按照推荐修改的情况，可以有两种方法解决：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e在eslintrc.js里面，在rules里面添加一个配置关闭报错。\u003c/li\u003e\n\u003cli\u003e在报错位置添加魔法注释（magic comments）\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e/* eslint-disable */\nsomething with eslint error\n/* eslint-enable */\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e如何自动按照eslint标准格式化\u003c/h3\u003e\n\u003cp\u003e可以配置编辑器在保存的时候自动格式化，也可以手动格式化，vue cli提供了一个功能 lint 用于格式化代码\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003eyarn lint // cli 的格式化指令\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e编写单元测试\u003c/h2\u003e\n\u003cp\u003e对于一些工具函数有必要编写测试方法，模板中列举了对日期格式化函数的单元测试，具体见 src/utils/formatDate。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003enpm i -D jest // 安装依赖\n\n// package.json\n\"script\": {\n   \"test\": \"jest --coverage\"\n}\n\n// .eslintrc.js\nenv: {\n  jest: true // 避免jest测试的函数报错\n},\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e运行 npm run test可以查看代码覆盖率等情况。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e// const formatDate = require(\"./formatDate\").formatDate;\n// or\nimport { formatDate } from \"./formatDate\";\n\ntest(\"formatDate\", () =\u003e {\n  expect(formatDate(null, \"yyyyMMdd\")).toEqual(\"\");\n  expect(formatDate(new Date(\"2020-11-11\"), \"yyyyMMdd\")).toEqual(\"20201111\");\n  expect(formatDate(new Date(\"2020-11-11 10:11:11\").getTime(), \"yyyyMMdd-hh:mm:ss\")).toEqual(\n    \"20201111-10:11:11\"\n  );\n  expect(\n    formatDate(Math.floor(new Date(\"2020-11-11\").getTime() / 1000), \"yyyyMMdd\")\n  ).toEqual(\"20201111\");\n});\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e项目打包的相关\u003c/h2\u003e\n\u003ch3\u003e配置不同的环境变量模式\u003c/h3\u003e\n\u003cp\u003evue/cli中默认设置了development、production等常用的环境变量。有的时候，项目还需要一个测试的环境，或者说项目在A版本的时候需要跳转a链接，但是到了B版本的时候却需要跳转b链接，本项目中使用的是自定义一个mode=test来配置。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-powershell\"\u003e# .env.test 文件\nNODE_ENV = production #表明打包的时候为生产环境\nVUE_APP_MODE = test #表明使用的是test变量flag来进行判断\nVUE_APP_PORTAL = https://v2.to.io/portal/ #也可以保存些信息\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样在打包的时候，可以运行\u003ccode\u003e \"build:test\": \"vue-cli-service build --mode test\",\u003c/code\u003e实现按照flag打包。\u003c/p\u003e\n\u003ch3\u003evue.config.js\u003c/h3\u003e\n\u003cp\u003e最终是暴露出一个对象，所有的webpack的配置都是在这个对象中去配置的，最后通过vue/cli的merge与基本的配置合并。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst webpackConfig = {};\nmodule.exports = webpackConfig;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e开启gzip\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst CompressionPlugin = require(\"compression-webpack-plugin\");\n\nif (process.env.NODE_ENV === \"production\") {\n  webpackConfig[\"configureWebpack\"] = config =\u003e {\n     config[\"plugins\"].push(\n      new CompressionPlugin({\n        test: /\\.js$|\\.html$|\\.css$/, // 匹配文件名\n        threshold: 10240, // 对超过10k的数据压缩\n        deleteOriginalAssets: true\n      })\n    );\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e图片压缩\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst customOptions = {\n  mozjpeg: {\n    progressive: true,\n    quality: 50\n  },\n  optipng: {\n    enabled: true\n  },\n  pngquant: {\n    quality: [0.5, 0.65],\n    speed: 4\n  },\n  gifsicle: {\n    interlaced: false\n  },\n  // 不支持WEBP就不要写这一项\n  webp: {\n    quality: 75\n  }\n};\nif (process.env.NODE_ENV === \"production\") {\n  webpackConfig[\"chainWebpack\"] = config =\u003e {\n    config.module\n      .rule(\"images\")\n      .test(/\\.(gif|png|jpe?g|svg)$/i)\n      .use(\"image-webpack-loader\")\n      .loader(\"image-webpack-loader\")\n      .options(customOptions)\n      .end();\n  };\n}  \n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e关闭sourceMap\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst webpackConfig = {\n  // 生产环境关闭sourceMap\n  productionSourceMap: false\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e查看打包优化的包体积\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst BundleAnalyzerPlugin = require(\"webpack-bundle-analyzer\")\n  .BundleAnalyzerPlugin;\nif (process.env.NODE_ENV === \"production\") {\n  webpackConfig[\"configureWebpack\"] = config =\u003e {\n    config[\"plugins\"].push(\n      new BundleAnalyzerPlugin({\n        analyzerMode: \"static\",\n        openAnalyzer: false,\n        reportFilename: `../reports/r-${new Date().getTime()}.html`\n      })\n    );\n  }  \n}\n// 可以把/reports加入 .gitignore\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ewebpack-devSever\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst { VUE_APP_DEV_API } = process.env;\nif (process.env.NODE_ENV === \"development\") {\n  webpackConfig.devServer = {\n    // port: 8081, // 端口号\n    https: false, // https:{type:Boolean}\n    open: false, // 配置自动启动浏览器,\n    proxy: {\n      \"/api\": {\n        target: VUE_APP_DEV_API,\n        changeOrigin: true,\n        ws: true,\n        onProxyReq: (proxyReq, req, res) =\u003e {\n          proxyReq.setHeader(\"referer\", VUE_APP_DEV_API);\n        },\n        pathRewrite: {\n          \"^/api\": \"\"\n        }\n      }\n    }\n  };\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e前端开发脚手架\u003c/h2\u003e\n\u003ch2\u003e参考文章\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://woai3c.gitee.io/introduction-to-front-end-engineering/03.html#%E9%AB%98%E5%86%85%E8%81%9A-%E4%BD%8E%E8%80%A6%E5%90%88\"\u003e入门前端工程化\u003c/a\u003e\n\u003ca href=\"https://panjiachen.gitee.io/vue-element-admin-site/zh/\"\u003evue-element-admin\u003c/a\u003e\u003c/p\u003e\n","coverImage":"/assets/blog/vue-jquery.jfif"}},"__N_SSG":true},"page":"/tech/[slug]","query":{"slug":"refactor-vue"},"buildId":"Yuf4f2ACmA9noj0-JpLSF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>